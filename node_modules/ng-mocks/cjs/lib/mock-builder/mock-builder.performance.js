"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockBuilderPerformance = void 0;
var testing_1 = require("@angular/core/testing");
var ng_mocks_universe_1 = __importDefault(require("../common/ng-mocks-universe"));
var mock_builder_promise_1 = require("./mock-builder.promise");
var add_entities_to_map_1 = __importDefault(require("./performance/add-entities-to-map"));
var add_values_to_set_1 = __importDefault(require("./performance/add-values-to-set"));
var are_equal_config_params_1 = __importDefault(require("./performance/are-equal-config-params"));
var are_equal_maps_1 = __importDefault(require("./performance/are-equal-maps"));
var are_equal_providers_1 = __importDefault(require("./performance/are-equal-providers"));
var are_equal_sets_1 = __importDefault(require("./performance/are-equal-sets"));
var get_empty_config_1 = __importDefault(require("./performance/get-empty-config"));
var required_metadata_1 = __importDefault(require("./performance/required-metadata"));
var MockBuilderPerformance = /** @class */ (function (_super) {
    __extends(MockBuilderPerformance, _super);
    function MockBuilderPerformance() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    MockBuilderPerformance.prototype.build = function () {
        var global = ng_mocks_universe_1.default.global;
        // avoiding influences on cache when users extend the testing module.
        if (global.has('builder:module') && global.has('builder:config') && this.equalsTo(global.get('builder:config'))) {
            return (0, required_metadata_1.default)(global.get('builder:module'));
        }
        // removal of cached promise in case of mismatch
        if (global.has('builder:module')) {
            global.delete(global.get('builder:module'));
        }
        global.set('builder:config', this.cloneConfig());
        var ngModule = _super.prototype.build.call(this);
        global.set('builder:module', ngModule);
        // avoiding influences on cache when users extend the testing module.
        return (0, required_metadata_1.default)(ngModule);
    };
    MockBuilderPerformance.prototype.then = function (fulfill, reject) {
        return __awaiter(this, void 0, void 0, function () {
            var global, flags, promise;
            return __generator(this, function (_a) {
                global = ng_mocks_universe_1.default.global;
                flags = global.has('bullet') && global.has('builder:module') && global.has('builder:config');
                if (flags && this.equalsTo(global.get('builder:config'))) {
                    return [2 /*return*/, global.get(global.get('builder:module')).then(fulfill, reject)];
                }
                // we need to reset testing module in case if we are in bullet mode but current module does not match.
                if (global.has('bullet') && global.has('bullet:reset')) {
                    // tslint:disable-next-line no-console
                    console.warn('ngMocks.faster has zero effect due to changes in testing module between runs');
                    global.delete('bullet');
                    testing_1.TestBed.resetTestingModule();
                    global.set('bullet', true);
                }
                promise = _super.prototype.then.call(this, fulfill, reject);
                global.set(global.get('builder:module'), promise);
                return [2 /*return*/, promise];
            });
        });
    };
    MockBuilderPerformance.prototype.cloneConfig = function () {
        var config = (0, get_empty_config_1.default)();
        (0, add_values_to_set_1.default)(this.beforeCC, config.beforeCC);
        (0, add_values_to_set_1.default)(this.excludeDef, config.excludeDef);
        (0, add_values_to_set_1.default)(this.keepDef, config.keepDef);
        (0, add_values_to_set_1.default)(this.mockDef, config.mockDef);
        (0, add_values_to_set_1.default)(this.replaceDef, config.replaceDef);
        (0, add_entities_to_map_1.default)(this.configDef, config.configDef);
        (0, add_entities_to_map_1.default)(this.defProviders, config.defProviders);
        (0, add_entities_to_map_1.default)(this.defValue, config.defValue);
        (0, add_entities_to_map_1.default)(this.providerDef, config.providerDef);
        return config;
    };
    MockBuilderPerformance.prototype.equalsTo = function (prototype) {
        var e_1, _a, e_2, _b, e_3, _c;
        try {
            for (var _d = __values(['beforeCC', 'keepDef', 'replaceDef', 'excludeDef', 'mockDef']), _e = _d.next(); !_e.done; _e = _d.next()) {
                var key = _e.value;
                if (!(0, are_equal_sets_1.default)(this[key], prototype[key])) {
                    return false;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_e && !_e.done && (_a = _d.return)) _a.call(_d);
            }
            finally { if (e_1) throw e_1.error; }
        }
        try {
            for (var _f = __values(['defValue']), _g = _f.next(); !_g.done; _g = _f.next()) {
                var key = _g.value;
                if (!(0, are_equal_maps_1.default)(this[key], prototype[key])) {
                    return false;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_g && !_g.done && (_b = _f.return)) _b.call(_f);
            }
            finally { if (e_2) throw e_2.error; }
        }
        try {
            for (var _h = __values(['providerDef', 'defProviders']), _j = _h.next(); !_j.done; _j = _h.next()) {
                var key = _j.value;
                if (!(0, are_equal_maps_1.default)(this[key], prototype[key], are_equal_providers_1.default)) {
                    return false;
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_j && !_j.done && (_c = _h.return)) _c.call(_h);
            }
            finally { if (e_3) throw e_3.error; }
        }
        return (0, are_equal_maps_1.default)(this.configDef, prototype.configDef, are_equal_config_params_1.default);
    };
    return MockBuilderPerformance;
}(mock_builder_promise_1.MockBuilderPromise));
exports.MockBuilderPerformance = MockBuilderPerformance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1idWlsZGVyLnBlcmZvcm1hbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZy1tb2Nrcy9zcmMvbGliL21vY2stYnVpbGRlci9tb2NrLWJ1aWxkZXIucGVyZm9ybWFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxpREFBZ0Q7QUFFaEQsa0ZBQTBEO0FBRTFELCtEQUE0RDtBQUM1RCwwRkFBaUU7QUFDakUsc0ZBQTZEO0FBQzdELGtHQUF5RTtBQUN6RSxnRkFBd0Q7QUFDeEQsMEZBQWtFO0FBQ2xFLGdGQUF3RDtBQUN4RCxvRkFBNEQ7QUFDNUQsc0ZBQStEO0FBRy9EO0lBQTRDLDBDQUFrQjtJQUE5RDs7SUFxRkEsQ0FBQztJQXBGUSxzQ0FBSyxHQUFaO1FBQ0UsSUFBTSxNQUFNLEdBQUcsMkJBQWUsQ0FBQyxNQUFNLENBQUM7UUFFdEMscUVBQXFFO1FBQ3JFLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFO1lBQy9HLE9BQU8sSUFBQSwyQkFBZ0IsRUFBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztTQUN2RDtRQUVELGdEQUFnRDtRQUNoRCxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUNoQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO1NBQzdDO1FBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJ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QSxTQUFBLENBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFBLGdCQUFBLDRCQUFFO2dCQUE3RSxJQUFNLEdBQUcsV0FBQTtnQkFDWixJQUFJLENBQUMsSUFBQSx3QkFBWSxFQUFFLElBQVksQ0FBQyxHQUFHLENBQUMsRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDckQsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7YUFDRjs7Ozs7Ozs7OztZQUNELEtBQWtCLElBQUEsS0FBQSxTQUFBLENBQUMsVUFBVSxDQUFDLENBQUEsZ0JBQUEsNEJBQUU7Z0JBQTNCLElBQU0sR0FBRyxXQUFBO2dCQUNaLElBQUksQ0FBQyxJQUFBLHdCQUFZLEVBQUUsSUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO29CQUNyRCxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGOzs7Ozs7Ozs7O1lBQ0QsS0FBa0IsSUFBQSxLQUFBLFNBQUEsQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUEsZ0JBQUEsNEJBQUU7Z0JBQTlDLElBQU0sR0FBRyxXQUFBO2dCQUNaLElBQUksQ0FBQyxJQUFBLHdCQUFZLEVBQUUsSUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSw2QkFBaUIsQ0FBQyxFQUFFO29CQUN4RSxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGOzs7Ozs7Ozs7UUFFRCxPQUFPLElBQUEsd0JBQVksRUFBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxTQUFTLEVBQUUsaUNBQW9CLENBQUMsQ0FBQztJQUNqRixDQUFDO0lBQ0gsNkJBQUM7QUFBRCxDQUFDLEFBckZELENBQTRDLHlDQUFrQixHQXFGN0Q7QUFyRlksd0RBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmdNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRlc3RCZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xuXG5pbXBvcnQgbmdNb2Nrc1VuaXZlcnNlIGZyb20gJy4uL2NvbW1vbi9uZy1tb2Nrcy11bml2ZXJzZSc7XG5cbmltcG9ydCB7IE1vY2tCdWlsZGVyUHJvbWlzZSB9IGZyb20gJy4vbW9jay1idWlsZGVyLnByb21pc2UnO1xuaW1wb3J0IGFkZEVudGl0aWVzVG9NYXAgZnJvbSAnLi9wZXJmb3JtYW5jZS9hZGQtZW50aXRpZXMtdG8tbWFwJztcbmltcG9ydCBhZGRWYWx1ZXNUb1NldCBmcm9tICcuL3BlcmZvcm1hbmNlL2FkZC12YWx1ZXMtdG8tc2V0JztcbmltcG9ydCBhcmVFcXVhbENvbmZpZ1BhcmFtcyBmcm9tICcuL3BlcmZvcm1hbmNlL2FyZS1lcXVhbC1jb25maWctcGFyYW1zJztcbmltcG9ydCBhcmVFcXVhbE1hcHMgZnJvbSAnLi9wZXJmb3JtYW5jZS9hcmUtZXF1YWwtbWFwcyc7XG5pbXBvcnQgYXJlRXF1YWxQcm92aWRlcnMgZnJvbSAnLi9wZXJmb3JtYW5jZS9hcmUtZXF1YWwtcHJvdmlkZXJzJztcbmltcG9ydCBhcmVFcXVhbFNldHMgZnJvbSAnLi9wZXJmb3JtYW5jZS9hcmUtZXF1YWwtc2V0cyc7XG5pbXBvcnQgZ2V0RW1wdHlDb25maWcgZnJvbSAnLi9wZXJmb3JtYW5jZS9nZXQtZW1wdHktY29uZmlnJztcbmltcG9ydCByZXF1aXJlZE1ldGFkYXRhIGZyb20gJy4vcGVyZm9ybWFuY2UvcmVxdWlyZWQtbWV0YWRhdGEnO1xuaW1wb3J0IHsgSU1vY2tCdWlsZGVyUmVzdWx0IH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBNb2NrQnVpbGRlclBlcmZvcm1hbmNlIGV4dGVuZHMgTW9ja0J1aWxkZXJQcm9taXNlIHtcbiAgcHVibGljIGJ1aWxkKCk6IE5nTW9kdWxlIHtcbiAgICBjb25zdCBnbG9iYWwgPSBuZ01vY2tzVW5pdmVyc2UuZ2xvYmFsO1xuXG4gICAgLy8gYXZvaWRpbmcgaW5mbHVlbmNlcyBvbiBjYWNoZSB3aGVuIHVzZXJzIGV4dGVuZCB0aGUgdGVzdGluZyBtb2R1bGUuXG4gICAgaWYgKGdsb2JhbC5oYXMoJ2J1aWxkZXI6bW9kdWxlJykgJiYgZ2xvYmFsLmhhcygnYnVpbGRlcjpjb25maWcnKSAmJiB0aGlzLmVxdWFsc1RvKGdsb2JhbC5nZXQoJ2J1aWxkZXI6Y29uZmlnJykpKSB7XG4gICAgICByZXR1cm4gcmVxdWlyZWRNZXRhZGF0YShnbG9iYWwuZ2V0KCdidWlsZGVyOm1vZHVsZScpKTtcbiAgICB9XG5cbiAgICAvLyByZW1vdmFsIG9mIGNhY2hlZCBwcm9taXNlIGluIGNhc2Ugb2YgbWlzbWF0Y2hcbiAgICBpZiAoZ2xvYmFsLmhhcygnYnVpbGRlcjptb2R1bGUnKSkge1xuICAgICAgZ2xvYmFsLmRlbGV0ZShnbG9iYWwuZ2V0KCdidWlsZGVyOm1vZHVsZScpKTtcbiAgICB9XG5cbiAgICBnbG9iYWwuc2V0KCdidWlsZGVyOmNvbmZpZycsIHRoaXMuY2xvbmVDb25maWcoKSk7XG5cbiAgICBjb25zdCBuZ01vZHVsZSA9IHN1cGVyLmJ1aWxkKCk7XG4gICAgZ2xvYmFsLnNldCgnYnVpbGRlcjptb2R1bGUnLCBuZ01vZHVsZSk7XG5cbiAgICAvLyBhdm9pZGluZyBpbmZsdWVuY2VzIG9uIGNhY2hlIHdoZW4gdXNlcnMgZXh0ZW5kIHRoZSB0ZXN0aW5nIG1vZHVsZS5cbiAgICByZXR1cm4gcmVxdWlyZWRNZXRhZGF0YShuZ01vZHVsZSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdGhlbjxUUmVzdWx0MSA9IElNb2NrQnVpbGRlclJlc3VsdD4oXG4gICAgZnVsZmlsbD86ICgodmFsdWU6IElNb2NrQnVpbGRlclJlc3VsdCkgPT4gUHJvbWlzZUxpa2U8VFJlc3VsdDE+KSB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICAgcmVqZWN0PzogKChyZWFzb246IGFueSkgPT4gUHJvbWlzZUxpa2U8bmV2ZXI+KSB8IHVuZGVmaW5lZCB8IG51bGwsXG4gICk6IFByb21pc2U8VFJlc3VsdDE+IHtcbiAgICBjb25zdCBnbG9iYWwgPSBuZ01vY2tzVW5pdmVyc2UuZ2xvYmFsO1xuXG4gICAgY29uc3QgZmxhZ3MgPSBnbG9iYWwuaGFzKCdidWxsZXQnKSAmJiBnbG9iYWwuaGFzKCdidWlsZGVyOm1vZHVsZScpICYmIGdsb2JhbC5oYXMoJ2J1aWxkZXI6Y29uZmlnJyk7XG4gICAgaWYgKGZsYWdzICYmIHRoaXMuZXF1YWxzVG8oZ2xvYmFsLmdldCgnYnVpbGRlcjpjb25maWcnKSkpIHtcbiAgICAgIHJldHVybiBnbG9iYWwuZ2V0KGdsb2JhbC5nZXQoJ2J1aWxkZXI6bW9kdWxlJykpLnRoZW4oZnVsZmlsbCwgcmVqZWN0KTtcbiAgICB9XG5cbiAgICAvLyB3ZSBuZWVkIHRvIHJlc2V0IHRlc3RpbmcgbW9kdWxlIGluIGNhc2UgaWYgd2UgYXJlIGluIGJ1bGxldCBtb2RlIGJ1dCBjdXJyZW50IG1vZHVsZSBkb2VzIG5vdCBtYXRjaC5cbiAgICBpZiAoZ2xvYmFsLmhhcygnYnVsbGV0JykgJiYgZ2xvYmFsLmhhcygnYnVsbGV0OnJlc2V0JykpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLndhcm4oJ25nTW9ja3MuZmFzdGVyIGhhcyB6ZXJvIGVmZmVjdCBkdWUgdG8gY2hhbmdlcyBpbiB0ZXN0aW5nIG1vZHVsZSBiZXR3ZWVuIHJ1bnMnKTtcbiAgICAgIGdsb2JhbC5kZWxldGUoJ2J1bGxldCcpO1xuICAgICAgVGVzdEJlZC5yZXNldFRlc3RpbmdNb2R1bGUoKTtcbiAgICAgIGdsb2JhbC5zZXQoJ2J1bGxldCcsIHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IHByb21pc2UgPSBzdXBlci50aGVuKGZ1bGZpbGwsIHJlamVjdCk7XG4gICAgZ2xvYmFsLnNldChnbG9iYWwuZ2V0KCdidWlsZGVyOm1vZHVsZScpLCBwcm9taXNlKTtcblxuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZUNvbmZpZygpIHtcbiAgICBjb25zdCBjb25maWcgPSBnZXRFbXB0eUNvbmZpZygpO1xuXG4gICAgYWRkVmFsdWVzVG9TZXQodGhpcy5iZWZvcmVDQywgY29uZmlnLmJlZm9yZUNDKTtcbiAgICBhZGRWYWx1ZXNUb1NldCh0aGlzLmV4Y2x1ZGVEZWYsIGNvbmZpZy5leGNsdWRlRGVmKTtcbiAgICBhZGRWYWx1ZXNUb1NldCh0aGlzLmtlZXBEZWYsIGNvbmZpZy5rZWVwRGVmKTtcbiAgICBhZGRWYWx1ZXNUb1NldCh0aGlzLm1vY2tEZWYsIGNvbmZpZy5tb2NrRGVmKTtcbiAgICBhZGRWYWx1ZXNUb1NldCh0aGlzLnJlcGxhY2VEZWYsIGNvbmZpZy5yZXBsYWNlRGVmKTtcblxuICAgIGFkZEVudGl0aWVzVG9NYXAodGhpcy5jb25maWdEZWYsIGNvbmZpZy5jb25maWdEZWYpO1xuICAgIGFkZEVudGl0aWVzVG9NYXAodGhpcy5kZWZQcm92aWRlcnMsIGNvbmZpZy5kZWZQcm92aWRlcnMpO1xuICAgIGFkZEVudGl0aWVzVG9NYXAodGhpcy5kZWZWYWx1ZSwgY29uZmlnLmRlZlZhbHVlKTtcbiAgICBhZGRFbnRpdGllc1RvTWFwKHRoaXMucHJvdmlkZXJEZWYsIGNvbmZpZy5wcm92aWRlckRlZik7XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9XG5cbiAgcHJpdmF0ZSBlcXVhbHNUbyhwcm90b3R5cGU6IFJlY29yZDxhbnksIGFueT4pOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBbJ2JlZm9yZUNDJywgJ2tlZXBEZWYnLCAncmVwbGFjZURlZicsICdleGNsdWRlRGVmJywgJ21vY2tEZWYnXSkge1xuICAgICAgaWYgKCFhcmVFcXVhbFNldHMoKHRoaXMgYXMgYW55KVtrZXldLCBwcm90b3R5cGVba2V5XSkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGtleSBvZiBbJ2RlZlZhbHVlJ10pIHtcbiAgICAgIGlmICghYXJlRXF1YWxNYXBzKCh0aGlzIGFzIGFueSlba2V5XSwgcHJvdG90eXBlW2tleV0pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBrZXkgb2YgWydwcm92aWRlckRlZicsICdkZWZQcm92aWRlcnMnXSkge1xuICAgICAgaWYgKCFhcmVFcXVhbE1hcHMoKHRoaXMgYXMgYW55KVtrZXldLCBwcm90b3R5cGVba2V5XSwgYXJlRXF1YWxQcm92aWRlcnMpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXJlRXF1YWxNYXBzKHRoaXMuY29uZmlnRGVmLCBwcm90b3R5cGUuY29uZmlnRGVmLCBhcmVFcXVhbENvbmZpZ1BhcmFtcyk7XG4gIH1cbn1cbiJdfQ==