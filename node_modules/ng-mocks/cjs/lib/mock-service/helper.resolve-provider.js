"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_helpers_1 = require("../common/core.helpers");
var core_tokens_1 = require("../common/core.tokens");
var func_get_provider_1 = __importDefault(require("../common/func.get-provider"));
var func_is_ng_injection_token_1 = require("../common/func.is-ng-injection-token");
var ng_mocks_universe_1 = __importDefault(require("../common/ng-mocks-universe"));
var helper_mock_service_1 = __importDefault(require("./helper.mock-service"));
var mock_provider_1 = __importDefault(require("./mock-provider"));
var anyDiffers = function (a, b) {
    var e_1, _a;
    var keys = [];
    for (var _i = 2; _i < arguments.length; _i++) {
        keys[_i - 2] = arguments[_i];
    }
    try {
        for (var keys_1 = __values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
            var key = keys_1_1.value;
            if (a[key] !== b[key]) {
                return true;
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (keys_1_1 && !keys_1_1.done && (_a = keys_1.return)) _a.call(keys_1);
        }
        finally { if (e_1) throw e_1.error; }
    }
    return false;
};
var createFromResolution = function (provide, resolution) {
    var mockDef = resolution;
    var existingMock = ng_mocks_universe_1.default.builtProviders.get(provide);
    if (existingMock) {
        mockDef = existingMock;
    }
    // A case when a provider is actually a component, directive, pipe.
    if (typeof mockDef === 'function') {
        mockDef = {
            provide: provide,
            useClass: mockDef,
        };
    }
    return mockDef;
};
var isSuitableProvider = function (provider, provide) {
    return ng_mocks_universe_1.default.builtProviders.has(core_tokens_1.NG_MOCKS_INTERCEPTORS) &&
        ng_mocks_universe_1.default.builtProviders.get(core_tokens_1.NG_MOCKS_INTERCEPTORS) === null &&
        (0, func_is_ng_injection_token_1.isNgInjectionToken)(provide) &&
        provide.toString() === 'InjectionToken HTTP_INTERCEPTORS' &&
        provide !== provider;
};
var excludeInterceptors = function (provider, provide) {
    if (isSuitableProvider(provider, provide)) {
        if (provider.useFactory || provider.useValue) {
            return true;
        }
        var interceptor = provider.useExisting || provider.useClass;
        if (!ng_mocks_universe_1.default.builtProviders.has(interceptor) || ng_mocks_universe_1.default.builtProviders.get(interceptor) === null) {
            return true;
        }
    }
    return false;
};
var parseProvider = function (provider, callback) {
    var provide = (0, func_get_provider_1.default)(provider);
    var multi = provider !== provide && !!provider.multi;
    return {
        change: function () {
            if (callback) {
                callback();
            }
        },
        multi: multi,
        provide: provide,
    };
};
// if the provider is a value, we need to go through the value and to replace all mock instances.
var replaceWithMocks = function (provider, provide, mockDef) {
    if (provide !== provider && mockDef && mockDef.useValue) {
        var useValue = helper_mock_service_1.default.replaceWithMocks(mockDef.useValue);
        return useValue === mockDef.useValue
            ? mockDef
            : __assign(__assign({}, mockDef), { useValue: useValue });
    }
    return mockDef;
};
var createPredefinedMockProvider = function (provider, provide) {
    // Then we check decisions whether we should keep or replace a provider.
    if (ng_mocks_universe_1.default.builtProviders.has(provide)) {
        var mockDef = ng_mocks_universe_1.default.builtProviders.get(provide);
        if (mockDef === provide) {
            return provider;
        }
        return mockDef;
    }
    return undefined;
};
var createMockProvider = function (provider, provide, change) {
    var _a;
    var mockDef = createPredefinedMockProvider(provider, provide);
    if (!mockDef && ng_mocks_universe_1.default.flags.has('skipMock') && ng_mocks_universe_1.default.getResolution(provide) !== 'mock') {
        (_a = ng_mocks_universe_1.default.config.get('ngMocksDepsSkip')) === null || _a === void 0 ? void 0 : _a.add(provide);
        mockDef = provider;
    }
    if (!mockDef) {
        mockDef = (0, mock_provider_1.default)(provider);
    }
    mockDef = replaceWithMocks(provider, provide, mockDef);
    if (!areEqualDefs(mockDef, provider, provide)) {
        change();
    }
    // Touching only when we really provide a value.
    if (mockDef) {
        ng_mocks_universe_1.default.touches.add(provide);
    }
    return mockDef;
};
var areEqualDefs = function (mockDef, provider, provide) {
    var providerDiffers = false;
    var defDiffers = !mockDef;
    if (provider && mockDef && !defDiffers) {
        defDiffers = anyDiffers(provider, mockDef, 'provide', 'useValue', 'useClass', 'useExisting', 'useFactory', 'deps');
    }
    if (provider === provide && mockDef !== provider) {
        providerDiffers = true;
    }
    else if (provider !== provide && defDiffers) {
        providerDiffers = true;
    }
    return !providerDiffers;
};
var isPreconfiguredDependency = function (provider, provide) {
    //  we should not touch excluded providers.
    if (ng_mocks_universe_1.default.builtProviders.has(provide) && ng_mocks_universe_1.default.builtProviders.get(provide) === null) {
        return true;
    }
    if (provide !== provider && provider.deps) {
        (0, core_helpers_1.extractDependency)(provider.deps, ng_mocks_universe_1.default.config.get('ngMocksDeps'));
    }
    return excludeInterceptors(provider, provide);
};
// tries to resolve a provider based on current universe state.
exports.default = (function (provider, resolutions, changed) {
    var _a = parseProvider(provider, changed), provide = _a.provide, multi = _a.multi, change = _a.change;
    //  we should not touch our system providers.
    if (provider && typeof provider === 'object' && provider.useExisting && provider.useExisting.mockOf) {
        return provider;
    }
    if (isPreconfiguredDependency(provider, provide)) {
        return change();
    }
    if (resolutions.has(provide)) {
        return createFromResolution(provide, resolutions.get(provide));
    }
    var mockDef = createMockProvider(provider, provide, change);
    return multi && typeof mockDef === 'object' ? __assign(__assign({}, mockDef), { multi: multi }) : mockDef;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVyLnJlc29sdmUtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25nLW1vY2tzL3NyYy9saWIvbW9jay1zZXJ2aWNlL2hlbHBlci5yZXNvbHZlLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHVEQUEyRDtBQUMzRCxxREFBOEQ7QUFDOUQsa0ZBQTBEO0FBQzFELG1GQUEwRTtBQUMxRSxrRkFBMEQ7QUFFMUQsOEVBQXNEO0FBQ3RELGtFQUEyQztBQUUzQyxJQUFNLFVBQVUsR0FBRyxVQUFDLENBQU0sRUFBRSxDQUFNOztJQUFFLGNBQWlCO1NBQWpCLFVBQWlCLEVBQWpCLHFCQUFpQixFQUFqQixJQUFpQjtRQUFqQiw2QkFBaUI7OztRQUNuRCxLQUFrQixJQUFBLFNBQUEsU0FBQSxJQUFJLENBQUEsMEJBQUEsNENBQUU7WUFBbkIsSUFBTSxHQUFHLGlCQUFBO1lBQ1osSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQixPQUFPLElBQUksQ0FBQzthQUNiO1NBQ0Y7Ozs7Ozs7OztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyxDQUFDO0FBRUYsSUFBTSxvQkFBb0IsR0FBRyxVQUFDLE9BQVksRUFBRSxVQUFlO0lBQ3pELElBQUksT0FBTyxHQUFHLFVBQVUsQ0FBQztJQUV6QixJQUFNLFlBQVksR0FBRywyQkFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakUsSUFBSSxZQUFZLEVBQUU7UUFDaEIsT0FBTyxHQUFHLFlBQVksQ0FBQztLQUN4QjtJQUVELG1FQUFtRTtJQUNuRSxJQUFJLE9BQU8sT0FBTyxLQUFLLFVBQVUsRUFBRTtRQUNqQyxPQUFPLEdBQUc7WUFDUixPQUFPLFNBQUE7WUFDUCxRQUFRLEVBQUUsT0FBTztTQUNsQixDQUFDO0tBQ0g7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixJQUFNLGtCQUFrQixHQUFHLFVBQUMsUUFBYSxFQUFFLE9BQVk7SUFDckQsT0FBQSwyQkFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsbUNBQXFCLENBQUM7UUFDekQsMkJBQWUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLG1DQUFxQixDQUFDLEtBQUssSUFBSTtRQUNsRSxJQUFBLCtDQUFrQixFQUFDLE9BQU8sQ0FBQztRQUMzQixPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssa0NBQWtDO1FBQ3pELE9BQU8sS0FBSyxRQUFRO0FBSnBCLENBSW9CLENBQUM7QUFFdkIsSUFBTSxtQkFBbUIsR0FBRyxVQUFDLFFBQWEsRUFBRSxPQUFZO0lBQ3RELElBQUksa0JBQWtCLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1FBQ3pDLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFO1lBQzVDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxJQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDOUQsSUFBSSxDQUFDLDJCQUFlLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSwyQkFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hILE9BQU8sSUFBSSxDQUFDO1NBQ2I7S0FDRjtJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyxDQUFDO0FBRUYsSUFBTSxhQUFhLEdBQUcsVUFDcEIsUUFBYSxFQUNiLFFBQWE7SUFNYixJQUFNLE9BQU8sR0FBRyxJQUFBLDJCQUFlLEVBQUMsUUFBUSxDQUFDLENBQUM7SUFDMUMsSUFBTSxLQUFLLEdBQUcsUUFBUSxLQUFLLE9BQU8sSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztJQUV2RCxPQUFPO1FBQ0wsTUFBTSxFQUFFO1lBQ04sSUFBSSxRQUFRLEVBQUU7Z0JBQ1osUUFBUSxFQUFFLENBQUM7YUFDWjtRQUNILENBQUM7UUFDRCxLQUFLLE9BQUE7UUFDTCxPQUFPLFNBQUE7S0FDUixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsaUdBQWlHO0FBQ2pHLElBQU0sZ0JBQWdCLEdBQUcsVUFBQyxRQUFhLEVBQUUsT0FBWSxFQUFFLE9BQVk7SUFDakUsSUFBSSxPQUFPLEtBQUssUUFBUSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO1FBQ3ZELElBQU0sUUFBUSxHQUFHLDZCQUFpQixDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV0RSxPQUFPLFFBQVEsS0FBSyxPQUFPLENBQUMsUUFBUTtZQUNsQyxDQUFDLENBQUMsT0FBTztZQUNULENBQUMsdUJBQ00sT0FBTyxLQUNWLFFBQVEsVUFBQSxHQUNULENBQUM7S0FDUDtJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMsQ0FBQztBQUVGLElBQU0sNEJBQTRCLEdBQUcsVUFBQyxRQUFhLEVBQUUsT0FBWTtJQUMvRCx3RUFBd0U7SUFDeEUsSUFBSSwyQkFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDL0MsSUFBTSxPQUFPLEdBQUcsMkJBQWUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVELElBQUksT0FBTyxLQUFLLE9BQU8sRUFBRTtZQUN2QixPQUFPLFFBQVEsQ0FBQztTQUNqQjtRQUVELE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBRUQsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQyxDQUFDO0FBRUYsSUFBTSxrQkFBa0IsR0FBRyxVQUFDLFFBQWEsRUFBRSxPQUFZLEVBQUUsTUFBa0I7O0lBQ3pFLElBQUksT0FBTyxHQUFHLDRCQUE0QixDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUU5RCxJQUFJLENBQUMsT0FBTyxJQUFJLDJCQUFlLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSwyQkFBZSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxNQUFNLEVBQUU7UUFDMUcsTUFBQSwyQkFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsMENBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVELE9BQU8sR0FBRyxRQUFRLENBQUM7S0FDcEI7SUFDRCxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ1osT0FBTyxHQUFHLElBQUEsdUJBQVksRUFBQyxRQUFRLENBQUMsQ0FBQztLQUNsQztJQUVELE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsRUFBRTtRQUM3QyxNQUFNLEVBQUUsQ0FBQztLQUNWO0lBQ0QsZ0RBQWdEO0lBQ2hELElBQUksT0FBTyxFQUFFO1FBQ1gsMkJBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3RDO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyxDQUFDO0FBRUYsSUFBTSxZQUFZLEdBQUcsVUFBQyxPQUFZLEVBQUUsUUFBYSxFQUFFLE9BQVk7SUFDN0QsSUFBSSxlQUFlLEdBQUcsS0FBSyxDQUFDO0lBQzVCLElBQUksVUFBVSxHQUFHLENBQUMsT0FBTyxDQUFDO0lBQzFCLElBQUksUUFBUSxJQUFJLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUN0QyxVQUFVLEdBQUcsVUFBVSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztLQUNwSDtJQUNELElBQUksUUFBUSxLQUFLLE9BQU8sSUFBSSxPQUFPLEtBQUssUUFBUSxFQUFFO1FBQ2hELGVBQWUsR0FBRyxJQUFJLENBQUM7S0FDeEI7U0FBTSxJQUFJLFFBQVEsS0FBSyxPQUFPLElBQUksVUFBVSxFQUFFO1FBQzdDLGVBQWUsR0FBRyxJQUFJLENBQUM7S0FDeEI7SUFFRCxPQUFPLENBQUMsZUFBZSxDQUFDO0FBQzFCLENBQUMsQ0FBQztBQUVGLElBQU0seUJBQXlCLEdBQUcsVUFBQyxRQUFhLEVBQUUsT0FBWTtJQUM1RCwyQ0FBMkM7SUFDM0MsSUFBSSwyQkFBZSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksMkJBQWUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksRUFBRTtRQUN2RyxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsSUFBSSxPQUFPLEtBQUssUUFBUSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDekMsSUFBQSxnQ0FBaUIsRUFBQyxRQUFRLENBQUMsSUFBSSxFQUFFLDJCQUFlLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0tBQzdFO0lBRUQsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDaEQsQ0FBQyxDQUFDO0FBRUYsK0RBQStEO0FBQy9ELG1CQUFlLFVBQUMsUUFBYSxFQUFFLFdBQTBCLEVBQUUsT0FBb0I7SUFDdkUsSUFBQSxLQUE2QixhQUFhLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxFQUEzRCxPQUFPLGFBQUEsRUFBRSxLQUFLLFdBQUEsRUFBRSxNQUFNLFlBQXFDLENBQUM7SUFDcEUsNkNBQTZDO0lBQzdDLElBQUksUUFBUSxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxRQUFRLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFO1FBQ25HLE9BQU8sUUFBUSxDQUFDO0tBQ2pCO0lBQ0QsSUFBSSx5QkFBeUIsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLEVBQUU7UUFDaEQsT0FBTyxNQUFNLEVBQUUsQ0FBQztLQUNqQjtJQUNELElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUM1QixPQUFPLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDaEU7SUFFRCxJQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRTlELE9BQU8sS0FBSyxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsQ0FBQyxDQUFDLHVCQUFNLE9BQU8sS0FBRSxLQUFLLE9BQUEsSUFBRyxDQUFDLENBQUMsT0FBTyxDQUFDO0FBQ2hGLENBQUMsRUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4dHJhY3REZXBlbmRlbmN5IH0gZnJvbSAnLi4vY29tbW9uL2NvcmUuaGVscGVycyc7XG5pbXBvcnQgeyBOR19NT0NLU19JTlRFUkNFUFRPUlMgfSBmcm9tICcuLi9jb21tb24vY29yZS50b2tlbnMnO1xuaW1wb3J0IGZ1bmNHZXRQcm92aWRlciBmcm9tICcuLi9jb21tb24vZnVuYy5nZXQtcHJvdmlkZXInO1xuaW1wb3J0IHsgaXNOZ0luamVjdGlvblRva2VuIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctaW5qZWN0aW9uLXRva2VuJztcbmltcG9ydCBuZ01vY2tzVW5pdmVyc2UgZnJvbSAnLi4vY29tbW9uL25nLW1vY2tzLXVuaXZlcnNlJztcblxuaW1wb3J0IGhlbHBlck1vY2tTZXJ2aWNlIGZyb20gJy4vaGVscGVyLm1vY2stc2VydmljZSc7XG5pbXBvcnQgbW9ja1Byb3ZpZGVyIGZyb20gJy4vbW9jay1wcm92aWRlcic7XG5cbmNvbnN0IGFueURpZmZlcnMgPSAoYTogYW55LCBiOiBhbnksIC4uLmtleXM6IHN0cmluZ1tdKTogYm9vbGVhbiA9PiB7XG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICBpZiAoYVtrZXldICE9PSBiW2tleV0pIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmNvbnN0IGNyZWF0ZUZyb21SZXNvbHV0aW9uID0gKHByb3ZpZGU6IGFueSwgcmVzb2x1dGlvbjogYW55KSA9PiB7XG4gIGxldCBtb2NrRGVmID0gcmVzb2x1dGlvbjtcblxuICBjb25zdCBleGlzdGluZ01vY2sgPSBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuZ2V0KHByb3ZpZGUpO1xuICBpZiAoZXhpc3RpbmdNb2NrKSB7XG4gICAgbW9ja0RlZiA9IGV4aXN0aW5nTW9jaztcbiAgfVxuXG4gIC8vIEEgY2FzZSB3aGVuIGEgcHJvdmlkZXIgaXMgYWN0dWFsbHkgYSBjb21wb25lbnQsIGRpcmVjdGl2ZSwgcGlwZS5cbiAgaWYgKHR5cGVvZiBtb2NrRGVmID09PSAnZnVuY3Rpb24nKSB7XG4gICAgbW9ja0RlZiA9IHtcbiAgICAgIHByb3ZpZGUsXG4gICAgICB1c2VDbGFzczogbW9ja0RlZixcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIG1vY2tEZWY7XG59O1xuXG5jb25zdCBpc1N1aXRhYmxlUHJvdmlkZXIgPSAocHJvdmlkZXI6IGFueSwgcHJvdmlkZTogYW55KTogYm9vbGVhbiA9PlxuICBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuaGFzKE5HX01PQ0tTX0lOVEVSQ0VQVE9SUykgJiZcbiAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmdldChOR19NT0NLU19JTlRFUkNFUFRPUlMpID09PSBudWxsICYmXG4gIGlzTmdJbmplY3Rpb25Ub2tlbihwcm92aWRlKSAmJlxuICBwcm92aWRlLnRvU3RyaW5nKCkgPT09ICdJbmplY3Rpb25Ub2tlbiBIVFRQX0lOVEVSQ0VQVE9SUycgJiZcbiAgcHJvdmlkZSAhPT0gcHJvdmlkZXI7XG5cbmNvbnN0IGV4Y2x1ZGVJbnRlcmNlcHRvcnMgPSAocHJvdmlkZXI6IGFueSwgcHJvdmlkZTogYW55KTogYm9vbGVhbiA9PiB7XG4gIGlmIChpc1N1aXRhYmxlUHJvdmlkZXIocHJvdmlkZXIsIHByb3ZpZGUpKSB7XG4gICAgaWYgKHByb3ZpZGVyLnVzZUZhY3RvcnkgfHwgcHJvdmlkZXIudXNlVmFsdWUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBpbnRlcmNlcHRvciA9IHByb3ZpZGVyLnVzZUV4aXN0aW5nIHx8IHByb3ZpZGVyLnVzZUNsYXNzO1xuICAgIGlmICghbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmhhcyhpbnRlcmNlcHRvcikgfHwgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmdldChpbnRlcmNlcHRvcikgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmNvbnN0IHBhcnNlUHJvdmlkZXIgPSAoXG4gIHByb3ZpZGVyOiBhbnksXG4gIGNhbGxiYWNrOiBhbnksXG4pOiB7XG4gIGNoYW5nZTogKCkgPT4gdm9pZDtcbiAgbXVsdGk6IGJvb2xlYW47XG4gIHByb3ZpZGU6IGFueTtcbn0gPT4ge1xuICBjb25zdCBwcm92aWRlID0gZnVuY0dldFByb3ZpZGVyKHByb3ZpZGVyKTtcbiAgY29uc3QgbXVsdGkgPSBwcm92aWRlciAhPT0gcHJvdmlkZSAmJiAhIXByb3ZpZGVyLm11bHRpO1xuXG4gIHJldHVybiB7XG4gICAgY2hhbmdlOiAoKSA9PiB7XG4gICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIG11bHRpLFxuICAgIHByb3ZpZGUsXG4gIH07XG59O1xuXG4vLyBpZiB0aGUgcHJvdmlkZXIgaXMgYSB2YWx1ZSwgd2UgbmVlZCB0byBnbyB0aHJvdWdoIHRoZSB2YWx1ZSBhbmQgdG8gcmVwbGFjZSBhbGwgbW9jayBpbnN0YW5jZXMuXG5jb25zdCByZXBsYWNlV2l0aE1vY2tzID0gKHByb3ZpZGVyOiBhbnksIHByb3ZpZGU6IGFueSwgbW9ja0RlZjogYW55KSA9PiB7XG4gIGlmIChwcm92aWRlICE9PSBwcm92aWRlciAmJiBtb2NrRGVmICYmIG1vY2tEZWYudXNlVmFsdWUpIHtcbiAgICBjb25zdCB1c2VWYWx1ZSA9IGhlbHBlck1vY2tTZXJ2aWNlLnJlcGxhY2VXaXRoTW9ja3MobW9ja0RlZi51c2VWYWx1ZSk7XG5cbiAgICByZXR1cm4gdXNlVmFsdWUgPT09IG1vY2tEZWYudXNlVmFsdWVcbiAgICAgID8gbW9ja0RlZlxuICAgICAgOiB7XG4gICAgICAgICAgLi4ubW9ja0RlZixcbiAgICAgICAgICB1c2VWYWx1ZSxcbiAgICAgICAgfTtcbiAgfVxuXG4gIHJldHVybiBtb2NrRGVmO1xufTtcblxuY29uc3QgY3JlYXRlUHJlZGVmaW5lZE1vY2tQcm92aWRlciA9IChwcm92aWRlcjogYW55LCBwcm92aWRlOiBhbnkpOiBhbnkgPT4ge1xuICAvLyBUaGVuIHdlIGNoZWNrIGRlY2lzaW9ucyB3aGV0aGVyIHdlIHNob3VsZCBrZWVwIG9yIHJlcGxhY2UgYSBwcm92aWRlci5cbiAgaWYgKG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5oYXMocHJvdmlkZSkpIHtcbiAgICBjb25zdCBtb2NrRGVmID0gbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmdldChwcm92aWRlKTtcbiAgICBpZiAobW9ja0RlZiA9PT0gcHJvdmlkZSkge1xuICAgICAgcmV0dXJuIHByb3ZpZGVyO1xuICAgIH1cblxuICAgIHJldHVybiBtb2NrRGVmO1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmNvbnN0IGNyZWF0ZU1vY2tQcm92aWRlciA9IChwcm92aWRlcjogYW55LCBwcm92aWRlOiBhbnksIGNoYW5nZTogKCkgPT4gdm9pZCkgPT4ge1xuICBsZXQgbW9ja0RlZiA9IGNyZWF0ZVByZWRlZmluZWRNb2NrUHJvdmlkZXIocHJvdmlkZXIsIHByb3ZpZGUpO1xuXG4gIGlmICghbW9ja0RlZiAmJiBuZ01vY2tzVW5pdmVyc2UuZmxhZ3MuaGFzKCdza2lwTW9jaycpICYmIG5nTW9ja3NVbml2ZXJzZS5nZXRSZXNvbHV0aW9uKHByb3ZpZGUpICE9PSAnbW9jaycpIHtcbiAgICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLmdldCgnbmdNb2Nrc0RlcHNTa2lwJyk/LmFkZChwcm92aWRlKTtcbiAgICBtb2NrRGVmID0gcHJvdmlkZXI7XG4gIH1cbiAgaWYgKCFtb2NrRGVmKSB7XG4gICAgbW9ja0RlZiA9IG1vY2tQcm92aWRlcihwcm92aWRlcik7XG4gIH1cblxuICBtb2NrRGVmID0gcmVwbGFjZVdpdGhNb2Nrcyhwcm92aWRlciwgcHJvdmlkZSwgbW9ja0RlZik7XG4gIGlmICghYXJlRXF1YWxEZWZzKG1vY2tEZWYsIHByb3ZpZGVyLCBwcm92aWRlKSkge1xuICAgIGNoYW5nZSgpO1xuICB9XG4gIC8vIFRvdWNoaW5nIG9ubHkgd2hlbiB3ZSByZWFsbHkgcHJvdmlkZSBhIHZhbHVlLlxuICBpZiAobW9ja0RlZikge1xuICAgIG5nTW9ja3NVbml2ZXJzZS50b3VjaGVzLmFkZChwcm92aWRlKTtcbiAgfVxuXG4gIHJldHVybiBtb2NrRGVmO1xufTtcblxuY29uc3QgYXJlRXF1YWxEZWZzID0gKG1vY2tEZWY6IGFueSwgcHJvdmlkZXI6IGFueSwgcHJvdmlkZTogYW55KTogYm9vbGVhbiA9PiB7XG4gIGxldCBwcm92aWRlckRpZmZlcnMgPSBmYWxzZTtcbiAgbGV0IGRlZkRpZmZlcnMgPSAhbW9ja0RlZjtcbiAgaWYgKHByb3ZpZGVyICYmIG1vY2tEZWYgJiYgIWRlZkRpZmZlcnMpIHtcbiAgICBkZWZEaWZmZXJzID0gYW55RGlmZmVycyhwcm92aWRlciwgbW9ja0RlZiwgJ3Byb3ZpZGUnLCAndXNlVmFsdWUnLCAndXNlQ2xhc3MnLCAndXNlRXhpc3RpbmcnLCAndXNlRmFjdG9yeScsICdkZXBzJyk7XG4gIH1cbiAgaWYgKHByb3ZpZGVyID09PSBwcm92aWRlICYmIG1vY2tEZWYgIT09IHByb3ZpZGVyKSB7XG4gICAgcHJvdmlkZXJEaWZmZXJzID0gdHJ1ZTtcbiAgfSBlbHNlIGlmIChwcm92aWRlciAhPT0gcHJvdmlkZSAmJiBkZWZEaWZmZXJzKSB7XG4gICAgcHJvdmlkZXJEaWZmZXJzID0gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiAhcHJvdmlkZXJEaWZmZXJzO1xufTtcblxuY29uc3QgaXNQcmVjb25maWd1cmVkRGVwZW5kZW5jeSA9IChwcm92aWRlcjogYW55LCBwcm92aWRlOiBhbnkpOiBib29sZWFuID0+IHtcbiAgLy8gIHdlIHNob3VsZCBub3QgdG91Y2ggZXhjbHVkZWQgcHJvdmlkZXJzLlxuICBpZiAobmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmhhcyhwcm92aWRlKSAmJiBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuZ2V0KHByb3ZpZGUpID09PSBudWxsKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpZiAocHJvdmlkZSAhPT0gcHJvdmlkZXIgJiYgcHJvdmlkZXIuZGVwcykge1xuICAgIGV4dHJhY3REZXBlbmRlbmN5KHByb3ZpZGVyLmRlcHMsIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCduZ01vY2tzRGVwcycpKTtcbiAgfVxuXG4gIHJldHVybiBleGNsdWRlSW50ZXJjZXB0b3JzKHByb3ZpZGVyLCBwcm92aWRlKTtcbn07XG5cbi8vIHRyaWVzIHRvIHJlc29sdmUgYSBwcm92aWRlciBiYXNlZCBvbiBjdXJyZW50IHVuaXZlcnNlIHN0YXRlLlxuZXhwb3J0IGRlZmF1bHQgKHByb3ZpZGVyOiBhbnksIHJlc29sdXRpb25zOiBNYXA8YW55LCBhbnk+LCBjaGFuZ2VkPzogKCkgPT4gdm9pZCkgPT4ge1xuICBjb25zdCB7IHByb3ZpZGUsIG11bHRpLCBjaGFuZ2UgfSA9IHBhcnNlUHJvdmlkZXIocHJvdmlkZXIsIGNoYW5nZWQpO1xuICAvLyAgd2Ugc2hvdWxkIG5vdCB0b3VjaCBvdXIgc3lzdGVtIHByb3ZpZGVycy5cbiAgaWYgKHByb3ZpZGVyICYmIHR5cGVvZiBwcm92aWRlciA9PT0gJ29iamVjdCcgJiYgcHJvdmlkZXIudXNlRXhpc3RpbmcgJiYgcHJvdmlkZXIudXNlRXhpc3RpbmcubW9ja09mKSB7XG4gICAgcmV0dXJuIHByb3ZpZGVyO1xuICB9XG4gIGlmIChpc1ByZWNvbmZpZ3VyZWREZXBlbmRlbmN5KHByb3ZpZGVyLCBwcm92aWRlKSkge1xuICAgIHJldHVybiBjaGFuZ2UoKTtcbiAgfVxuICBpZiAocmVzb2x1dGlvbnMuaGFzKHByb3ZpZGUpKSB7XG4gICAgcmV0dXJuIGNyZWF0ZUZyb21SZXNvbHV0aW9uKHByb3ZpZGUsIHJlc29sdXRpb25zLmdldChwcm92aWRlKSk7XG4gIH1cblxuICBjb25zdCBtb2NrRGVmID0gY3JlYXRlTW9ja1Byb3ZpZGVyKHByb3ZpZGVyLCBwcm92aWRlLCBjaGFuZ2UpO1xuXG4gIHJldHVybiBtdWx0aSAmJiB0eXBlb2YgbW9ja0RlZiA9PT0gJ29iamVjdCcgPyB7IC4uLm1vY2tEZWYsIG11bHRpIH0gOiBtb2NrRGVmO1xufTtcbiJdfQ==