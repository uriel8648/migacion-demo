"use strict";
// tslint:disable variable-name
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Mock = void 0;
var core_1 = require("@angular/core");
var mock_helper_stub_1 = __importDefault(require("../mock-helper/mock-helper.stub"));
var mock_instance_apply_1 = __importDefault(require("../mock-instance/mock-instance-apply"));
var helper_mock_service_1 = __importDefault(require("../mock-service/helper.mock-service"));
var core_define_property_1 = __importDefault(require("./core.define-property"));
var core_form_1 = __importDefault(require("./core.form"));
var core_helpers_1 = require("./core.helpers");
var func_is_mock_1 = __importDefault(require("./func.is-mock"));
var mock_control_value_accessor_proxy_1 = require("./mock-control-value-accessor-proxy");
var ng_mocks_universe_1 = __importDefault(require("./ng-mocks-universe"));
var setValueAccessor = function (instance, ngControl) {
    if (ngControl && !ngControl.valueAccessor && instance.__ngMocksConfig.setControlValueAccessor) {
        try {
            ngControl.valueAccessor = new mock_control_value_accessor_proxy_1.MockControlValueAccessorProxy(instance.__ngMocksCtor);
        }
        catch (e) {
            // nothing to do.
        }
    }
};
// connecting to NG_VALUE_ACCESSOR
var installValueAccessor = function (ngControl, instance) {
    if (!ngControl.valueAccessor.instance && ngControl.valueAccessor.target === instance.__ngMocksCtor) {
        ngControl.valueAccessor.instance = instance;
        helper_mock_service_1.default.mock(instance, 'registerOnChange');
        helper_mock_service_1.default.mock(instance, 'registerOnTouched');
        helper_mock_service_1.default.mock(instance, 'setDisabledState');
        helper_mock_service_1.default.mock(instance, 'writeValue');
        instance.__ngMocksConfig.isControlValueAccessor = true;
    }
};
// connecting to NG_VALIDATORS
// connecting to NG_ASYNC_VALIDATORS
var installValidator = function (validators, instance) {
    var e_1, _a;
    try {
        for (var validators_1 = __values(validators), validators_1_1 = validators_1.next(); !validators_1_1.done; validators_1_1 = validators_1.next()) {
            var validator = validators_1_1.value;
            if (!validator.instance && validator.target === instance.__ngMocksCtor) {
                validator.instance = instance;
                helper_mock_service_1.default.mock(instance, 'registerOnValidatorChange');
                helper_mock_service_1.default.mock(instance, 'validate');
                instance.__ngMocksConfig.isValidator = true;
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (validators_1_1 && !validators_1_1.done && (_a = validators_1.return)) _a.call(validators_1);
        }
        finally { if (e_1) throw e_1.error; }
    }
};
var applyNgValueAccessor = function (instance, ngControl) {
    setValueAccessor(instance, ngControl);
    try {
        // istanbul ignore else
        if (ngControl) {
            installValueAccessor(ngControl, instance);
            installValidator(ngControl._rawValidators, instance);
            installValidator(ngControl._rawAsyncValidators, instance);
        }
    }
    catch (e) {
        // nothing to do.
    }
};
var applyOutputs = function (instance) {
    var e_2, _a, e_3, _b;
    var mockOutputs = [];
    try {
        for (var _c = __values(instance.__ngMocksConfig.outputs || []), _d = _c.next(); !_d.done; _d = _c.next()) {
            var output = _d.value;
            mockOutputs.push(output.split(':')[0]);
        }
    }
    catch (e_2_1) { e_2 = { error: e_2_1 }; }
    finally {
        try {
            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
        }
        finally { if (e_2) throw e_2.error; }
    }
    try {
        for (var mockOutputs_1 = __values(mockOutputs), mockOutputs_1_1 = mockOutputs_1.next(); !mockOutputs_1_1.done; mockOutputs_1_1 = mockOutputs_1.next()) {
            var output = mockOutputs_1_1.value;
            if (instance[output] || Object.getOwnPropertyDescriptor(instance, output)) {
                continue;
            }
            instance[output] = new core_1.EventEmitter();
        }
    }
    catch (e_3_1) { e_3 = { error: e_3_1 }; }
    finally {
        try {
            if (mockOutputs_1_1 && !mockOutputs_1_1.done && (_b = mockOutputs_1.return)) _b.call(mockOutputs_1);
        }
        finally { if (e_3) throw e_3.error; }
    }
};
var applyPrototype = function (instance, prototype) {
    var e_4, _a;
    try {
        for (var _b = __values(__spreadArray(__spreadArray([], __read(helper_mock_service_1.default.extractMethodsFromPrototype(prototype)), false), __read(helper_mock_service_1.default.extractPropertiesFromPrototype(prototype)), false)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var prop = _c.value;
            var descriptor = helper_mock_service_1.default.extractPropertyDescriptor(prototype, prop);
            helper_mock_service_1.default.definePropertyDescriptor(instance, prop, descriptor);
        }
    }
    catch (e_4_1) { e_4 = { error: e_4_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_4) throw e_4.error; }
    }
};
var applyMethods = function (instance, prototype) {
    var e_5, _a;
    try {
        for (var _b = __values(helper_mock_service_1.default.extractMethodsFromPrototype(prototype)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var method = _c.value;
            if (instance[method] || Object.getOwnPropertyDescriptor(instance, method)) {
                continue;
            }
            helper_mock_service_1.default.mock(instance, method);
        }
    }
    catch (e_5_1) { e_5 = { error: e_5_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_5) throw e_5.error; }
    }
};
var applyProps = function (instance, prototype) {
    var e_6, _a;
    try {
        for (var _b = __values(helper_mock_service_1.default.extractPropertiesFromPrototype(prototype)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var prop = _c.value;
            if (instance[prop] || Object.getOwnPropertyDescriptor(instance, prop)) {
                continue;
            }
            helper_mock_service_1.default.mock(instance, prop, 'get');
            helper_mock_service_1.default.mock(instance, prop, 'set');
        }
    }
    catch (e_6_1) { e_6 = { error: e_6_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_6) throw e_6.error; }
    }
};
var applyOverrides = function (instance, mockOf, injector) {
    var e_7, _a;
    var configGlobal = ng_mocks_universe_1.default.getOverrides().get(mockOf);
    var callbacks = configGlobal ? (0, core_helpers_1.mapValues)(configGlobal) : [];
    if (instance.__ngMocksConfig.init) {
        callbacks.push(instance.__ngMocksConfig.init);
    }
    callbacks.push.apply(callbacks, __spreadArray([], __read((0, mock_instance_apply_1.default)(mockOf)), false));
    try {
        for (var callbacks_1 = __values(callbacks), callbacks_1_1 = callbacks_1.next(); !callbacks_1_1.done; callbacks_1_1 = callbacks_1.next()) {
            var callback = callbacks_1_1.value;
            var overrides = callback(instance, injector);
            if (!overrides) {
                continue;
            }
            (0, mock_helper_stub_1.default)(instance, overrides);
        }
    }
    catch (e_7_1) { e_7 = { error: e_7_1 }; }
    finally {
        try {
            if (callbacks_1_1 && !callbacks_1_1.done && (_a = callbacks_1.return)) _a.call(callbacks_1);
        }
        finally { if (e_7) throw e_7.error; }
    }
};
var Mock = /** @class */ (function () {
    function Mock(injector, ngControl) {
        var e_8, _a;
        if (injector === void 0) { injector = null; }
        if (ngControl === void 0) { ngControl = null; }
        var mockOf = this.constructor.mockOf;
        (0, core_define_property_1.default)(this, '__ngMocksInjector', injector);
        (0, core_define_property_1.default)(this, '__ngMocksCtor', this.constructor);
        try {
            for (var _b = __values(this.__ngMocksConfig.queryScanKeys || /* istanbul ignore next */ []), _c = _b.next(); !_c.done; _c = _b.next()) {
                var key = _c.value;
                (0, core_define_property_1.default)(this, "__ngMocksVcr_" + key, undefined);
            }
        }
        catch (e_8_1) { e_8 = { error: e_8_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_8) throw e_8.error; }
        }
        // istanbul ignore else
        if ((0, func_is_mock_1.default)(this)) {
            applyNgValueAccessor(this, ngControl);
            applyOutputs(this);
            applyPrototype(this, Object.getPrototypeOf(this));
            applyMethods(this, mockOf.prototype);
            applyProps(this, mockOf.prototype);
        }
        // and faking prototype
        Object.setPrototypeOf(this, mockOf.prototype);
        applyOverrides(this, mockOf, injector !== null && injector !== void 0 ? injector : undefined);
    }
    return Mock;
}());
exports.Mock = Mock;
(0, core_define_property_1.default)(Mock, 'parameters', [
    [core_1.Injector, new core_1.Optional()],
    [core_form_1.default.NgControl || /* istanbul ignore next */ (function () { return undefined; }), new core_1.Optional(), new core_1.Self()],
]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmctbW9ja3Mvc3JjL2xpYi9jb21tb24vbW9jay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsK0JBQStCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFL0Isc0NBQXVFO0FBR3ZFLHFGQUE2RDtBQUM3RCw2RkFBcUU7QUFDckUsNEZBQW9FO0FBRXBFLGdGQUF3RDtBQUN4RCwwREFBbUM7QUFDbkMsK0NBQTJDO0FBRTNDLGdFQUF3QztBQUN4Qyx5RkFBb0Y7QUFDcEYsMEVBQWtEO0FBRWxELElBQU0sZ0JBQWdCLEdBQUcsVUFBQyxRQUFhLEVBQUUsU0FBZTtJQUN0RCxJQUFJLFNBQVMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyx1QkFBdUIsRUFBRTtRQUM3RixJQUFJO1lBQ0YsU0FBUyxDQUFDLGFBQWEsR0FBRyxJQUFJLGlFQUE2QixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNyRjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsaUJBQWlCO1NBQ2xCO0tBQ0Y7QUFDSCxDQUFDLENBQUM7QUFFRixrQ0FBa0M7QUFDbEMsSUFBTSxvQkFBb0IsR0FBRyxVQUFDLFNBQWMsRUFBRSxRQUFhO0lBQ3pELElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLFFBQVEsSUFBSSxTQUFTLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUMsYUFBYSxFQUFFO1FBQ2xHLFNBQVMsQ0FBQyxhQUFhLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUM1Qyw2QkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDckQsNkJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3RELDZC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LENBQUMsQ0FBQzthQUM1RDs7Ozs7Ozs7O1FBRUQsdUJBQXVCO1FBQ3ZCLElBQUksSUFBQSxzQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BCLG9CQUFvQixDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN0QyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbkIsY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbEQsWUFBWSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDckMsVUFBVSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDcEM7UUFFRCx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLFFBQVEsYUFBUixRQUFRLGNBQVIsUUFBUSxHQUFJLFNBQVMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFDSCxXQUFDO0FBQUQsQ0FBQyxBQTVCRCxJQTRCQztBQTVCWSxvQkFBSTtBQThCakIsSUFBQSw4QkFBa0IsRUFBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO0lBQ3JDLENBQUMsZUFBUSxFQUFFLElBQUksZUFBUSxFQUFFLENBQUM7SUFDMUIsQ0FBQyxtQkFBUSxDQUFDLFNBQVMsSUFBSSwwQkFBMEIsQ0FBQyxDQUFDLGNBQU0sT0FBQSxTQUFTLEVBQVQsQ0FBUyxDQUFDLEVBQUUsSUFBSSxlQUFRLEVBQUUsRUFBRSxJQUFJLFdBQUksRUFBRSxDQUFDO0NBQ2pHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIHZhcmlhYmxlLW5hbWVcblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RvciwgT3B0aW9uYWwsIFNlbGYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgSU1vY2tCdWlsZGVyQ29uZmlnIH0gZnJvbSAnLi4vbW9jay1idWlsZGVyL3R5cGVzJztcbmltcG9ydCBtb2NrSGVscGVyU3R1YiBmcm9tICcuLi9tb2NrLWhlbHBlci9tb2NrLWhlbHBlci5zdHViJztcbmltcG9ydCBtb2NrSW5zdGFuY2VBcHBseSBmcm9tICcuLi9tb2NrLWluc3RhbmNlL21vY2staW5zdGFuY2UtYXBwbHknO1xuaW1wb3J0IGhlbHBlck1vY2tTZXJ2aWNlIGZyb20gJy4uL21vY2stc2VydmljZS9oZWxwZXIubW9jay1zZXJ2aWNlJztcblxuaW1wb3J0IGNvcmVEZWZpbmVQcm9wZXJ0eSBmcm9tICcuL2NvcmUuZGVmaW5lLXByb3BlcnR5JztcbmltcG9ydCBjb3JlRm9ybSBmcm9tICcuL2NvcmUuZm9ybSc7XG5pbXBvcnQgeyBtYXBWYWx1ZXMgfSBmcm9tICcuL2NvcmUuaGVscGVycyc7XG5pbXBvcnQgeyBBbnlUeXBlIH0gZnJvbSAnLi9jb3JlLnR5cGVzJztcbmltcG9ydCBmdW5jSXNNb2NrIGZyb20gJy4vZnVuYy5pcy1tb2NrJztcbmltcG9ydCB7IE1vY2tDb250cm9sVmFsdWVBY2Nlc3NvclByb3h5IH0gZnJvbSAnLi9tb2NrLWNvbnRyb2wtdmFsdWUtYWNjZXNzb3ItcHJveHknO1xuaW1wb3J0IG5nTW9ja3NVbml2ZXJzZSBmcm9tICcuL25nLW1vY2tzLXVuaXZlcnNlJztcblxuY29uc3Qgc2V0VmFsdWVBY2Nlc3NvciA9IChpbnN0YW5jZTogYW55LCBuZ0NvbnRyb2w/OiBhbnkpID0+IHtcbiAgaWYgKG5nQ29udHJvbCAmJiAhbmdDb250cm9sLnZhbHVlQWNjZXNzb3IgJiYgaW5zdGFuY2UuX19uZ01vY2tzQ29uZmlnLnNldENvbnRyb2xWYWx1ZUFjY2Vzc29yKSB7XG4gICAgdHJ5IHtcbiAgICAgIG5nQ29udHJvbC52YWx1ZUFjY2Vzc29yID0gbmV3IE1vY2tDb250cm9sVmFsdWVBY2Nlc3NvclByb3h5KGluc3RhbmNlLl9fbmdNb2Nrc0N0b3IpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIG5vdGhpbmcgdG8gZG8uXG4gICAgfVxuICB9XG59O1xuXG4vLyBjb25uZWN0aW5nIHRvIE5HX1ZBTFVFX0FDQ0VTU09SXG5jb25zdCBpbnN0YWxsVmFsdWVBY2Nlc3NvciA9IChuZ0NvbnRyb2w6IGFueSwgaW5zdGFuY2U6IGFueSkgPT4ge1xuICBpZiAoIW5nQ29udHJvbC52YWx1ZUFjY2Vzc29yLmluc3RhbmNlICYmIG5nQ29udHJvbC52YWx1ZUFjY2Vzc29yLnRhcmdldCA9PT0gaW5zdGFuY2UuX19uZ01vY2tzQ3Rvcikge1xuICAgIG5nQ29udHJvbC52YWx1ZUFjY2Vzc29yLmluc3RhbmNlID0gaW5zdGFuY2U7XG4gICAgaGVscGVyTW9ja1NlcnZpY2UubW9jayhpbnN0YW5jZSwgJ3JlZ2lzdGVyT25DaGFuZ2UnKTtcbiAgICBoZWxwZXJNb2NrU2VydmljZS5tb2NrKGluc3RhbmNlLCAncmVnaXN0ZXJPblRvdWNoZWQnKTtcbiAgICBoZWxwZXJNb2NrU2VydmljZS5tb2NrKGluc3RhbmNlLCAnc2V0RGlzYWJsZWRTdGF0ZScpO1xuICAgIGhlbHBlck1vY2tTZXJ2aWNlLm1vY2soaW5zdGFuY2UsICd3cml0ZVZhbHVlJyk7XG4gICAgaW5zdGFuY2UuX19uZ01vY2tzQ29uZmlnLmlzQ29udHJvbFZhbHVlQWNjZXNzb3IgPSB0cnVlO1xuICB9XG59O1xuXG4vLyBjb25uZWN0aW5nIHRvIE5HX1ZBTElEQVRPUlNcbi8vIGNvbm5lY3RpbmcgdG8gTkdfQVNZTkNfVkFMSURBVE9SU1xuY29uc3QgaW5zdGFsbFZhbGlkYXRvciA9ICh2YWxpZGF0b3JzOiBhbnlbXSwgaW5zdGFuY2U6IGFueSkgPT4ge1xuICBmb3IgKGNvbnN0IHZhbGlkYXRvciBvZiB2YWxpZGF0b3JzKSB7XG4gICAgaWYgKCF2YWxpZGF0b3IuaW5zdGFuY2UgJiYgdmFsaWRhdG9yLnRhcmdldCA9PT0gaW5zdGFuY2UuX19uZ01vY2tzQ3Rvcikge1xuICAgICAgdmFsaWRhdG9yLmluc3RhbmNlID0gaW5zdGFuY2U7XG4gICAgICBoZWxwZXJNb2NrU2VydmljZS5tb2NrKGluc3RhbmNlLCAncmVnaXN0ZXJPblZhbGlkYXRvckNoYW5nZScpO1xuICAgICAgaGVscGVyTW9ja1NlcnZpY2UubW9jayhpbnN0YW5jZSwgJ3ZhbGlkYXRlJyk7XG4gICAgICBpbnN0YW5jZS5fX25nTW9ja3NDb25maWcuaXNWYWxpZGF0b3IgPSB0cnVlO1xuICAgIH1cbiAgfVxufTtcblxuY29uc3QgYXBwbHlOZ1ZhbHVlQWNjZXNzb3IgPSAoaW5zdGFuY2U6IGFueSwgbmdDb250cm9sOiBhbnkpID0+IHtcbiAgc2V0VmFsdWVBY2Nlc3NvcihpbnN0YW5jZSwgbmdDb250cm9sKTtcblxuICB0cnkge1xuICAgIC8vIGlzdGFuYnVsIGlnbm9yZSBlbHNlXG4gICAgaWYgKG5nQ29udHJvbCkge1xuICAgICAgaW5zdGFsbFZhbHVlQWNjZXNzb3IobmdDb250cm9sLCBpbnN0YW5jZSk7XG4gICAgICBpbnN0YWxsVmFsaWRhdG9yKG5nQ29udHJvbC5fcmF3VmFsaWRhdG9ycywgaW5zdGFuY2UpO1xuICAgICAgaW5zdGFsbFZhbGlkYXRvcihuZ0NvbnRyb2wuX3Jhd0FzeW5jVmFsaWRhdG9ycywgaW5zdGFuY2UpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIG5vdGhpbmcgdG8gZG8uXG4gIH1cbn07XG5cbmNvbnN0IGFwcGx5T3V0cHV0cyA9IChpbnN0YW5jZTogTW9ja0NvbmZpZyAmIFJlY29yZDxrZXlvZiBhbnksIGFueT4pID0+IHtcbiAgY29uc3QgbW9ja091dHB1dHMgPSBbXTtcbiAgZm9yIChjb25zdCBvdXRwdXQgb2YgaW5zdGFuY2UuX19uZ01vY2tzQ29uZmlnLm91dHB1dHMgfHwgW10pIHtcbiAgICBtb2NrT3V0cHV0cy5wdXNoKG91dHB1dC5zcGxpdCgnOicpWzBdKTtcbiAgfVxuXG4gIGZvciAoY29uc3Qgb3V0cHV0IG9mIG1vY2tPdXRwdXRzKSB7XG4gICAgaWYgKGluc3RhbmNlW291dHB1dF0gfHwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihpbnN0YW5jZSwgb3V0cHV0KSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGluc3RhbmNlW291dHB1dF0gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgfVxufTtcblxuY29uc3QgYXBwbHlQcm90b3R5cGUgPSAoaW5zdGFuY2U6IE1vY2ssIHByb3RvdHlwZTogQW55VHlwZTxhbnk+KSA9PiB7XG4gIGZvciAoY29uc3QgcHJvcCBvZiBbXG4gICAgLi4uaGVscGVyTW9ja1NlcnZpY2UuZXh0cmFjdE1ldGhvZHNGcm9tUHJvdG90eXBlKHByb3RvdHlwZSksXG4gICAgLi4uaGVscGVyTW9ja1NlcnZpY2UuZXh0cmFjdFByb3BlcnRpZXNGcm9tUHJvdG90eXBlKHByb3RvdHlwZSksXG4gIF0pIHtcbiAgICBjb25zdCBkZXNjcmlwdG9yID0gaGVscGVyTW9ja1NlcnZpY2UuZXh0cmFjdFByb3BlcnR5RGVzY3JpcHRvcihwcm90b3R5cGUsIHByb3ApO1xuICAgIGhlbHBlck1vY2tTZXJ2aWNlLmRlZmluZVByb3BlcnR5RGVzY3JpcHRvcihpbnN0YW5jZSwgcHJvcCwgZGVzY3JpcHRvcik7XG4gIH1cbn07XG5cbmNvbnN0IGFwcGx5TWV0aG9kcyA9IChpbnN0YW5jZTogTW9jayAmIFJlY29yZDxrZXlvZiBhbnksIGFueT4sIHByb3RvdHlwZTogQW55VHlwZTxhbnk+KSA9PiB7XG4gIGZvciAoY29uc3QgbWV0aG9kIG9mIGhlbHBlck1vY2tTZXJ2aWNlLmV4dHJhY3RNZXRob2RzRnJvbVByb3RvdHlwZShwcm90b3R5cGUpKSB7XG4gICAgaWYgKGluc3RhbmNlW21ldGhvZF0gfHwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihpbnN0YW5jZSwgbWV0aG9kKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGhlbHBlck1vY2tTZXJ2aWNlLm1vY2soaW5zdGFuY2UsIG1ldGhvZCk7XG4gIH1cbn07XG5cbmNvbnN0IGFwcGx5UHJvcHMgPSAoaW5zdGFuY2U6IE1vY2sgJiBSZWNvcmQ8a2V5b2YgYW55LCBhbnk+LCBwcm90b3R5cGU6IEFueVR5cGU8YW55PikgPT4ge1xuICBmb3IgKGNvbnN0IHByb3Agb2YgaGVscGVyTW9ja1NlcnZpY2UuZXh0cmFjdFByb3BlcnRpZXNGcm9tUHJvdG90eXBlKHByb3RvdHlwZSkpIHtcbiAgICBpZiAoaW5zdGFuY2VbcHJvcF0gfHwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihpbnN0YW5jZSwgcHJvcCkpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBoZWxwZXJNb2NrU2VydmljZS5tb2NrKGluc3RhbmNlLCBwcm9wLCAnZ2V0Jyk7XG4gICAgaGVscGVyTW9ja1NlcnZpY2UubW9jayhpbnN0YW5jZSwgcHJvcCwgJ3NldCcpO1xuICB9XG59O1xuXG5leHBvcnQgdHlwZSBuZ01vY2tzTW9ja0NvbmZpZyA9IHtcbiAgY29uZmlnPzogSU1vY2tCdWlsZGVyQ29uZmlnO1xuICBpbml0PzogKGluc3RhbmNlOiBhbnkpID0+IHZvaWQ7XG4gIGlzQ29udHJvbFZhbHVlQWNjZXNzb3I/OiBib29sZWFuO1xuICBpc1ZhbGlkYXRvcj86IGJvb2xlYW47XG4gIG91dHB1dHM/OiBzdHJpbmdbXTtcbiAgcXVlcnlTY2FuS2V5cz86IHN0cmluZ1tdO1xuICBzZXRDb250cm9sVmFsdWVBY2Nlc3Nvcj86IGJvb2xlYW47XG59O1xuXG5jb25zdCBhcHBseU92ZXJyaWRlcyA9IChpbnN0YW5jZTogYW55LCBtb2NrT2Y6IGFueSwgaW5qZWN0b3I/OiBJbmplY3Rvcik6IHZvaWQgPT4ge1xuICBjb25zdCBjb25maWdHbG9iYWw6IFNldDxhbnk+IHwgdW5kZWZpbmVkID0gbmdNb2Nrc1VuaXZlcnNlLmdldE92ZXJyaWRlcygpLmdldChtb2NrT2YpO1xuICBjb25zdCBjYWxsYmFja3MgPSBjb25maWdHbG9iYWwgPyBtYXBWYWx1ZXMoY29uZmlnR2xvYmFsKSA6IFtdO1xuICBpZiAoaW5zdGFuY2UuX19uZ01vY2tzQ29uZmlnLmluaXQpIHtcbiAgICBjYWxsYmFja3MucHVzaChpbnN0YW5jZS5fX25nTW9ja3NDb25maWcuaW5pdCk7XG4gIH1cbiAgY2FsbGJhY2tzLnB1c2goLi4ubW9ja0luc3RhbmNlQXBwbHkobW9ja09mKSk7XG5cbiAgZm9yIChjb25zdCBjYWxsYmFjayBvZiBjYWxsYmFja3MpIHtcbiAgICBjb25zdCBvdmVycmlkZXMgPSBjYWxsYmFjayhpbnN0YW5jZSwgaW5qZWN0b3IpO1xuICAgIGlmICghb3ZlcnJpZGVzKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgbW9ja0hlbHBlclN0dWIoaW5zdGFuY2UsIG92ZXJyaWRlcyk7XG4gIH1cbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW9ja0NvbmZpZyB7XG4gIF9fbmdNb2Nrc0NvbmZpZzogbmdNb2Nrc01vY2tDb25maWc7XG59XG5cbmV4cG9ydCBjbGFzcyBNb2NrIHtcbiAgcHJvdGVjdGVkIF9fbmdNb2Nrc0NvbmZpZyE6IG5nTW9ja3NNb2NrQ29uZmlnO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBpbmplY3RvcjogSW5qZWN0b3IgfCBudWxsID0gbnVsbCxcbiAgICBuZ0NvbnRyb2w6IGFueSB8IG51bGwgPSBudWxsLCAvLyBOZ0NvbnRyb2xcbiAgKSB7XG4gICAgY29uc3QgbW9ja09mID0gKHRoaXMuY29uc3RydWN0b3IgYXMgYW55KS5tb2NrT2Y7XG4gICAgY29yZURlZmluZVByb3BlcnR5KHRoaXMsICdfX25nTW9ja3NJbmplY3RvcicsIGluamVjdG9yKTtcbiAgICBjb3JlRGVmaW5lUHJvcGVydHkodGhpcywgJ19fbmdNb2Nrc0N0b3InLCB0aGlzLmNvbnN0cnVjdG9yKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLl9fbmdNb2Nrc0NvbmZpZy5xdWVyeVNjYW5LZXlzIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIFtdKSB7XG4gICAgICBjb3JlRGVmaW5lUHJvcGVydHkodGhpcywgYF9fbmdNb2Nrc1Zjcl8ke2tleX1gLCB1bmRlZmluZWQpO1xuICAgIH1cblxuICAgIC8vIGlzdGFuYnVsIGlnbm9yZSBlbHNlXG4gICAgaWYgKGZ1bmNJc01vY2sodGhpcykpIHtcbiAgICAgIGFwcGx5TmdWYWx1ZUFjY2Vzc29yKHRoaXMsIG5nQ29udHJvbCk7XG4gICAgICBhcHBseU91dHB1dHModGhpcyk7XG4gICAgICBhcHBseVByb3RvdHlwZSh0aGlzLCBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykpO1xuICAgICAgYXBwbHlNZXRob2RzKHRoaXMsIG1vY2tPZi5wcm90b3R5cGUpO1xuICAgICAgYXBwbHlQcm9wcyh0aGlzLCBtb2NrT2YucHJvdG90eXBlKTtcbiAgICB9XG5cbiAgICAvLyBhbmQgZmFraW5nIHByb3RvdHlwZVxuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBtb2NrT2YucHJvdG90eXBlKTtcblxuICAgIGFwcGx5T3ZlcnJpZGVzKHRoaXMsIG1vY2tPZiwgaW5qZWN0b3IgPz8gdW5kZWZpbmVkKTtcbiAgfVxufVxuXG5jb3JlRGVmaW5lUHJvcGVydHkoTW9jaywgJ3BhcmFtZXRlcnMnLCBbXG4gIFtJbmplY3RvciwgbmV3IE9wdGlvbmFsKCldLFxuICBbY29yZUZvcm0uTmdDb250cm9sIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovICgoKSA9PiB1bmRlZmluZWQpLCBuZXcgT3B0aW9uYWwoKSwgbmV3IFNlbGYoKV0sXG5dKTtcbiJdfQ==