"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockRenderFactory = void 0;
var core_1 = require("@angular/core");
var testing_1 = require("@angular/core/testing");
var core_define_property_1 = __importDefault(require("../common/core.define-property"));
var func_import_exists_1 = __importDefault(require("../common/func.import-exists"));
var func_is_ng_def_1 = require("../common/func.is-ng-def");
var ng_mocks_stack_1 = __importDefault(require("../common/ng-mocks-stack"));
var ng_mocks_universe_1 = __importDefault(require("../common/ng-mocks-universe"));
var mock_helper_1 = require("../mock-helper/mock-helper");
var helper_define_property_descriptor_1 = __importDefault(require("../mock-service/helper.define-property-descriptor"));
var mock_service_1 = require("../mock-service/mock-service");
var func_create_wrapper_1 = __importDefault(require("./func.create-wrapper"));
var func_install_prop_reader_1 = __importDefault(require("./func.install-prop-reader"));
var func_reflect_template_1 = __importDefault(require("./func.reflect-template"));
var isExpectedRender = function (template) {
    return typeof template === 'string' || (0, func_is_ng_def_1.isNgDef)(template, 'c') || (0, func_is_ng_def_1.isNgDef)(template, 'd');
};
var renderDeclaration = function (fixture, template, params) {
    fixture.point = fixture.debugElement.children[0] || fixture.debugElement.childNodes[0];
    if ((0, func_is_ng_def_1.isNgDef)(template, 'd')) {
        (0, helper_define_property_descriptor_1.default)(fixture.point, 'componentInstance', {
            get: function () { return mock_helper_1.ngMocks.get(fixture.point, template); },
        });
    }
    tryWhen(!params, function () { var _a; return (0, func_install_prop_reader_1.default)(fixture.componentInstance, (_a = fixture.point) === null || _a === void 0 ? void 0 : _a.componentInstance, []); });
};
var renderInjection = function (fixture, template, params) {
    var instance = testing_1.TestBed.get(template);
    if (params) {
        mock_helper_1.ngMocks.stub(instance, params);
    }
    fixture.point = (0, mock_service_1.MockService)(core_1.DebugElement, {
        childNodes: [],
        children: [],
        componentInstance: instance,
        nativeElement: (0, mock_service_1.MockService)(HTMLElement),
    });
    (0, func_install_prop_reader_1.default)(fixture.componentInstance, fixture.point.componentInstance, [], true);
};
var tryWhen = function (flag, callback) {
    if (!flag) {
        return;
    }
    try {
        // ivy throws Error: Expecting instance of DOM Element
        callback();
    }
    catch (e) {
        // nothing to do
    }
};
var fixtureMessage = [
    'Forgot to flush TestBed?',
    'MockRender cannot be used without a reset after TestBed.get / TestBed.inject / TestBed.createComponent and another MockRender in the same test.',
    'If you want to mock a service before rendering, consider usage of MockRenderFactory or MockInstance.',
    'To flush TestBed, add a call of ngMocks.flushTestBed() before the call of MockRender, or pass `reset: true` to MockRender options.',
].join(' ');
var handleFixtureError = function (e) {
    var error = new Error(fixtureMessage);
    (0, core_define_property_1.default)(error, 'parent', e, false);
    throw error;
};
var flushTestBed = function (flags) {
    var globalFlags = ng_mocks_universe_1.default.global.get('flags');
    var testBed = (0, testing_1.getTestBed)();
    if (flags.reset || (!testBed._instantiated && !testBed._testModuleRef)) {
        mock_helper_1.ngMocks.flushTestBed();
    }
    else if (globalFlags.onTestBedFlushNeed !== 'throw' && (testBed._testModuleRef || testBed._instantiated)) {
        if (globalFlags.onTestBedFlushNeed === 'warn') {
            // tslint:disable-next-line:no-console
            console.warn(fixtureMessage);
        }
        mock_helper_1.ngMocks.flushTestBed();
    }
};
var generateFactoryInstall = function (ctor, options) { return function () {
    var _a;
    var testBed = (0, testing_1.getTestBed)();
    var declarations = ((_a = testBed._compiler) === null || _a === void 0 ? void 0 : _a.declarations) || testBed.declarations || testBed._declarations;
    if (!declarations || declarations.indexOf(ctor) === -1) {
        flushTestBed(options);
        try {
            testing_1.TestBed.configureTestingModule({
                declarations: [ctor],
            });
        }
        catch (e) {
            handleFixtureError(e);
        }
    }
}; };
var generateFactory = function (componentCtor, bindings, template, options) {
    var result = function (params, detectChanges) {
        result.configureTestBed();
        var fixture = testing_1.TestBed.createComponent(componentCtor);
        (0, func_install_prop_reader_1.default)(fixture.componentInstance, params !== null && params !== void 0 ? params : {}, bindings !== null && bindings !== void 0 ? bindings : []);
        (0, core_define_property_1.default)(fixture, 'ngMocksStackId', ng_mocks_universe_1.default.global.get('bullet:stack:id'));
        if (detectChanges === undefined || detectChanges) {
            fixture.detectChanges();
        }
        if (isExpectedRender(template)) {
            renderDeclaration(fixture, template, params);
        }
        else {
            renderInjection(fixture, template, params);
        }
        return fixture;
    };
    result.declaration = componentCtor;
    result.bindings = bindings;
    result.configureTestBed = generateFactoryInstall(componentCtor, options);
    return result;
};
function MockRenderFactory(template, bindings, options) {
    if (options === void 0) { options = {}; }
    (0, func_import_exists_1.default)(template, 'MockRender');
    var meta = typeof template === 'string' || (0, func_is_ng_def_1.isNgDef)(template, 't') ? {} : (0, func_reflect_template_1.default)(template);
    var componentCtor = (0, func_create_wrapper_1.default)(template, meta, bindings, options);
    var factory = generateFactory(componentCtor, bindings, template, options);
    if (ng_mocks_stack_1.default.current().level !== 'root' && options.configureTestBed !== false) {
        factory.configureTestBed();
    }
    return factory;
}
exports.MockRenderFactory = MockRenderFactory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1yZW5kZXItZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmctbW9ja3Mvc3JjL2xpYi9tb2NrLXJlbmRlci9tb2NrLXJlbmRlci1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNDQUF3RTtBQUN4RSxpREFBNEQ7QUFFNUQsd0ZBQWdFO0FBRWhFLG9GQUE0RDtBQUM1RCwyREFBbUQ7QUFDbkQsNEVBQW9EO0FBQ3BELGtGQUEwRDtBQUMxRCwwREFBcUQ7QUFDckQsd0hBQStGO0FBQy9GLDZEQUEyRDtBQUUzRCw4RUFBc0Q7QUFDdEQsd0ZBQStEO0FBQy9ELGtGQUEwRDtBQVUxRCxJQUFNLGdCQUFnQixHQUFHLFVBQUMsUUFBYTtJQUNyQyxPQUFBLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxJQUFBLHdCQUFPLEVBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLElBQUEsd0JBQU8sRUFBQyxRQUFRLEVBQUUsR0FBRyxDQUFDO0FBQWhGLENBQWdGLENBQUM7QUFFbkYsSUFBTSxpQkFBaUIsR0FBRyxVQUFDLE9BQVksRUFBRSxRQUFhLEVBQUUsTUFBVztJQUNqRSxPQUFPLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZGLElBQUksSUFBQSx3QkFBTyxFQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBRTtRQUMxQixJQUFBLDJDQUE4QixFQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsbUJBQW1CLEVBQUU7WUFDakUsR0FBRyxFQUFFLGNBQU0sT0FBQSxxQkFBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxFQUFwQyxDQUFvQztTQUNoRCxDQUFDLENBQUM7S0FDSjtJQUNE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ZXNDb250ZW50IjpbImltcG9ydCB7IERlYnVnRWxlbWVudCwgRGlyZWN0aXZlLCBJbmplY3Rpb25Ub2tlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZ2V0VGVzdEJlZCwgVGVzdEJlZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5cbmltcG9ydCBjb3JlRGVmaW5lUHJvcGVydHkgZnJvbSAnLi4vY29tbW9uL2NvcmUuZGVmaW5lLXByb3BlcnR5JztcbmltcG9ydCB7IEFueVR5cGUsIFR5cGUgfSBmcm9tICcuLi9jb21tb24vY29yZS50eXBlcyc7XG5pbXBvcnQgZnVuY0ltcG9ydEV4aXN0cyBmcm9tICcuLi9jb21tb24vZnVuYy5pbXBvcnQtZXhpc3RzJztcbmltcG9ydCB7IGlzTmdEZWYgfSBmcm9tICcuLi9jb21tb24vZnVuYy5pcy1uZy1kZWYnO1xuaW1wb3J0IG5nTW9ja3NTdGFjayBmcm9tICcuLi9jb21tb24vbmctbW9ja3Mtc3RhY2snO1xuaW1wb3J0IG5nTW9ja3NVbml2ZXJzZSBmcm9tICcuLi9jb21tb24vbmctbW9ja3MtdW5pdmVyc2UnO1xuaW1wb3J0IHsgbmdNb2NrcyB9IGZyb20gJy4uL21vY2staGVscGVyL21vY2staGVscGVyJztcbmltcG9ydCBoZWxwZXJEZWZpbmVQcm9wZXJ0eURlc2NyaXB0b3IgZnJvbSAnLi4vbW9jay1zZXJ2aWNlL2hlbHBlci5kZWZpbmUtcHJvcGVydHktZGVzY3JpcHRvcic7XG5pbXBvcnQgeyBNb2NrU2VydmljZSB9IGZyb20gJy4uL21vY2stc2VydmljZS9tb2NrLXNlcnZpY2UnO1xuXG5pbXBvcnQgZnVuY0NyZWF0ZVdyYXBwZXIgZnJvbSAnLi9mdW5jLmNyZWF0ZS13cmFwcGVyJztcbmltcG9ydCBmdW5jSW5zdGFsbFByb3BSZWFkZXIgZnJvbSAnLi9mdW5jLmluc3RhbGwtcHJvcC1yZWFkZXInO1xuaW1wb3J0IGZ1bmNSZWZsZWN0VGVtcGxhdGUgZnJvbSAnLi9mdW5jLnJlZmxlY3QtdGVtcGxhdGUnO1xuaW1wb3J0IHsgSU1vY2tSZW5kZXJGYWN0b3J5T3B0aW9ucywgTW9ja2VkQ29tcG9uZW50Rml4dHVyZSB9IGZyb20gJy4vdHlwZXMnO1xuXG5pbnRlcmZhY2UgTW9ja1JlbmRlckZhY3Rvcnk8QyA9IGFueSwgRiBleHRlbmRzIGtleW9mIGFueSA9IGtleW9mIEM+IHtcbiAgYmluZGluZ3M6IGtleW9mIEY7XG4gIGNvbmZpZ3VyZVRlc3RCZWQ6ICgpID0+IHZvaWQ7XG4gIGRlY2xhcmF0aW9uOiBBbnlUeXBlPG5ldmVyPjtcbiAgPFQgZXh0ZW5kcyBSZWNvcmQ8RiwgYW55Pj4ocGFyYW1zPzogUGFydGlhbDxUPiwgZGV0ZWN0Q2hhbmdlcz86IGJvb2xlYW4pOiBNb2NrZWRDb21wb25lbnRGaXh0dXJlPEMsIFQ+O1xufVxuXG5jb25zdCBpc0V4cGVjdGVkUmVuZGVyID0gKHRlbXBsYXRlOiBhbnkpOiBib29sZWFuID0+XG4gIHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycgfHwgaXNOZ0RlZih0ZW1wbGF0ZSwgJ2MnKSB8fCBpc05nRGVmKHRlbXBsYXRlLCAnZCcpO1xuXG5jb25zdCByZW5kZXJEZWNsYXJhdGlvbiA9IChmaXh0dXJlOiBhbnksIHRlbXBsYXRlOiBhbnksIHBhcmFtczogYW55KTogdm9pZCA9PiB7XG4gIGZpeHR1cmUucG9pbnQgPSBmaXh0dXJlLmRlYnVnRWxlbWVudC5jaGlsZHJlblswXSB8fCBmaXh0dXJlLmRlYnVnRWxlbWVudC5jaGlsZE5vZGVzWzBdO1xuICBpZiAoaXNOZ0RlZih0ZW1wbGF0ZSwgJ2QnKSkge1xuICAgIGhlbHBlckRlZmluZVByb3BlcnR5RGVzY3JpcHRvcihmaXh0dXJlLnBvaW50LCAnY29tcG9uZW50SW5zdGFuY2UnLCB7XG4gICAgICBnZXQ6ICgpID0+IG5nTW9ja3MuZ2V0KGZpeHR1cmUucG9pbnQsIHRlbXBsYXRlKSxcbiAgICB9KTtcbiAgfVxuICB0cnlXaGVuKCFwYXJhbXMsICgpID0+IGZ1bmNJbnN0YWxsUHJvcFJlYWRlcihmaXh0dXJlLmNvbXBvbmVudEluc3RhbmNlLCBmaXh0dXJlLnBvaW50Py5jb21wb25lbnRJbnN0YW5jZSwgW10pKTtcbn07XG5cbmNvbnN0IHJlbmRlckluamVjdGlvbiA9IChmaXh0dXJlOiBhbnksIHRlbXBsYXRlOiBhbnksIHBhcmFtczogYW55KTogdm9pZCA9PiB7XG4gIGNvbnN0IGluc3RhbmNlID0gVGVzdEJlZC5nZXQodGVtcGxhdGUpO1xuICBpZiAocGFyYW1zKSB7XG4gICAgbmdNb2Nrcy5zdHViKGluc3RhbmNlLCBwYXJhbXMpO1xuICB9XG4gIGZpeHR1cmUucG9pbnQgPSBNb2NrU2VydmljZShEZWJ1Z0VsZW1lbnQsIHtcbiAgICBjaGlsZE5vZGVzOiBbXSxcbiAgICBjaGlsZHJlbjogW10sXG4gICAgY29tcG9uZW50SW5zdGFuY2U6IGluc3RhbmNlLFxuICAgIG5hdGl2ZUVsZW1lbnQ6IE1vY2tTZXJ2aWNlKEhUTUxFbGVtZW50KSxcbiAgfSk7XG4gIGZ1bmNJbnN0YWxsUHJvcFJlYWRlcihmaXh0dXJlLmNvbXBvbmVudEluc3RhbmNlLCBmaXh0dXJlLnBvaW50LmNvbXBvbmVudEluc3RhbmNlLCBbXSwgdHJ1ZSk7XG59O1xuXG5jb25zdCB0cnlXaGVuID0gKGZsYWc6IGJvb2xlYW4sIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSA9PiB7XG4gIGlmICghZmxhZykge1xuICAgIHJldHVybjtcbiAgfVxuICB0cnkge1xuICAgIC8vIGl2eSB0aHJvd3MgRXJyb3I6IEV4cGVjdGluZyBpbnN0YW5jZSBvZiBET00gRWxlbWVudFxuICAgIGNhbGxiYWNrKCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBub3RoaW5nIHRvIGRvXG4gIH1cbn07XG5cbmNvbnN0IGZpeHR1cmVNZXNzYWdlID0gW1xuICAnRm9yZ290IHRvIGZsdXNoIFRlc3RCZWQ/JyxcbiAgJ01vY2tSZW5kZXIgY2Fubm90IGJlIHVzZWQgd2l0aG91dCBhIHJlc2V0IGFmdGVyIFRlc3RCZWQuZ2V0IC8gVGVzdEJlZC5pbmplY3QgLyBUZXN0QmVkLmNyZWF0ZUNvbXBvbmVudCBhbmQgYW5vdGhlciBNb2NrUmVuZGVyIGluIHRoZSBzYW1lIHRlc3QuJyxcbiAgJ0lmIHlvdSB3YW50IHRvIG1vY2sgYSBzZXJ2aWNlIGJlZm9yZSByZW5kZXJpbmcsIGNvbnNpZGVyIHVzYWdlIG9mIE1vY2tSZW5kZXJGYWN0b3J5IG9yIE1vY2tJbnN0YW5jZS4nLFxuICAnVG8gZmx1c2ggVGVzdEJlZCwgYWRkIGEgY2FsbCBvZiBuZ01vY2tzLmZsdXNoVGVzdEJlZCgpIGJlZm9yZSB0aGUgY2FsbCBvZiBNb2NrUmVuZGVyLCBvciBwYXNzIGByZXNldDogdHJ1ZWAgdG8gTW9ja1JlbmRlciBvcHRpb25zLicsXG5dLmpvaW4oJyAnKTtcblxuY29uc3QgaGFuZGxlRml4dHVyZUVycm9yID0gKGU6IGFueSkgPT4ge1xuICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihmaXh0dXJlTWVzc2FnZSk7XG4gIGNvcmVEZWZpbmVQcm9wZXJ0eShlcnJvciwgJ3BhcmVudCcsIGUsIGZhbHNlKTtcbiAgdGhyb3cgZXJyb3I7XG59O1xuXG5jb25zdCBmbHVzaFRlc3RCZWQgPSAoZmxhZ3M6IFJlY29yZDxzdHJpbmcsIGFueT4pOiB2b2lkID0+IHtcbiAgY29uc3QgZ2xvYmFsRmxhZ3MgPSBuZ01vY2tzVW5pdmVyc2UuZ2xvYmFsLmdldCgnZmxhZ3MnKTtcbiAgY29uc3QgdGVzdEJlZDogYW55ID0gZ2V0VGVzdEJlZCgpO1xuICBpZiAoZmxhZ3MucmVzZXQgfHwgKCF0ZXN0QmVkLl9pbnN0YW50aWF0ZWQgJiYgIXRlc3RCZWQuX3Rlc3RNb2R1bGVSZWYpKSB7XG4gICAgbmdNb2Nrcy5mbHVzaFRlc3RCZWQoKTtcbiAgfSBlbHNlIGlmIChnbG9iYWxGbGFncy5vblRlc3RCZWRGbHVzaE5lZWQgIT09ICd0aHJvdycgJiYgKHRlc3RCZWQuX3Rlc3RNb2R1bGVSZWYgfHwgdGVzdEJlZC5faW5zdGFudGlhdGVkKSkge1xuICAgIGlmIChnbG9iYWxGbGFncy5vblRlc3RCZWRGbHVzaE5lZWQgPT09ICd3YXJuJykge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUud2FybihmaXh0dXJlTWVzc2FnZSk7XG4gICAgfVxuICAgIG5nTW9ja3MuZmx1c2hUZXN0QmVkKCk7XG4gIH1cbn07XG5cbmNvbnN0IGdlbmVyYXRlRmFjdG9yeUluc3RhbGwgPSAoY3RvcjogQW55VHlwZTxhbnk+LCBvcHRpb25zOiBJTW9ja1JlbmRlckZhY3RvcnlPcHRpb25zKSA9PiAoKSA9PiB7XG4gIGNvbnN0IHRlc3RCZWQ6IFRlc3RCZWQgJiB7XG4gICAgX2NvbXBpbGVyPzoge1xuICAgICAgZGVjbGFyYXRpb25zPzogQXJyYXk8QW55VHlwZTxhbnk+PjtcbiAgICB9O1xuICAgIF9kZWNsYXJhdGlvbnM/OiBBcnJheTxBbnlUeXBlPGFueT4+O1xuICAgIGRlY2xhcmF0aW9ucz86IEFycmF5PEFueVR5cGU8YW55Pj47XG4gIH0gPSBnZXRUZXN0QmVkKCk7XG4gIGNvbnN0IGRlY2xhcmF0aW9ucyA9IHRlc3RCZWQuX2NvbXBpbGVyPy5kZWNsYXJhdGlvbnMgfHwgdGVzdEJlZC5kZWNsYXJhdGlvbnMgfHwgdGVzdEJlZC5fZGVjbGFyYXRpb25zO1xuICBpZiAoIWRlY2xhcmF0aW9ucyB8fCBkZWNsYXJhdGlvbnMuaW5kZXhPZihjdG9yKSA9PT0gLTEpIHtcbiAgICBmbHVzaFRlc3RCZWQob3B0aW9ucyk7XG4gICAgdHJ5IHtcbiAgICAgIFRlc3RCZWQuY29uZmlndXJlVGVzdGluZ01vZHVsZSh7XG4gICAgICAgIGRlY2xhcmF0aW9uczogW2N0b3JdLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaGFuZGxlRml4dHVyZUVycm9yKGUpO1xuICAgIH1cbiAgfVxufTtcblxuY29uc3QgZ2VuZXJhdGVGYWN0b3J5ID0gKFxuICBjb21wb25lbnRDdG9yOiBUeXBlPGFueT4sXG4gIGJpbmRpbmdzOiB1bmRlZmluZWQgfCBudWxsIHwgc3RyaW5nW10sXG4gIHRlbXBsYXRlOiBhbnksXG4gIG9wdGlvbnM6IElNb2NrUmVuZGVyRmFjdG9yeU9wdGlvbnMsXG4pID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gKHBhcmFtczogYW55LCBkZXRlY3RDaGFuZ2VzPzogYm9vbGVhbikgPT4ge1xuICAgIHJlc3VsdC5jb25maWd1cmVUZXN0QmVkKCk7XG4gICAgY29uc3QgZml4dHVyZTogYW55ID0gVGVzdEJlZC5jcmVhdGVDb21wb25lbnQoY29tcG9uZW50Q3Rvcik7XG5cbiAgICBmdW5jSW5zdGFsbFByb3BSZWFkZXIoZml4dHVyZS5jb21wb25lbnRJbnN0YW5jZSwgcGFyYW1zID8/IHt9LCBiaW5kaW5ncyA/PyBbXSk7XG4gICAgY29yZURlZmluZVByb3BlcnR5KGZpeHR1cmUsICduZ01vY2tzU3RhY2tJZCcsIG5nTW9ja3NVbml2ZXJzZS5nbG9iYWwuZ2V0KCdidWxsZXQ6c3RhY2s6aWQnKSk7XG5cbiAgICBpZiAoZGV0ZWN0Q2hhbmdlcyA9PT0gdW5kZWZpbmVkIHx8IGRldGVjdENoYW5nZXMpIHtcbiAgICAgIGZpeHR1cmUuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIGlmIChpc0V4cGVjdGVkUmVuZGVyKHRlbXBsYXRlKSkge1xuICAgICAgcmVuZGVyRGVjbGFyYXRpb24oZml4dHVyZSwgdGVtcGxhdGUsIHBhcmFtcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbmRlckluamVjdGlvbihmaXh0dXJlLCB0ZW1wbGF0ZSwgcGFyYW1zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZml4dHVyZTtcbiAgfTtcbiAgcmVzdWx0LmRlY2xhcmF0aW9uID0gY29tcG9uZW50Q3RvcjtcbiAgcmVzdWx0LmJpbmRpbmdzID0gYmluZGluZ3M7XG4gIHJlc3VsdC5jb25maWd1cmVUZXN0QmVkID0gZ2VuZXJhdGVGYWN0b3J5SW5zdGFsbChjb21wb25lbnRDdG9yLCBvcHRpb25zKTtcblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBAc2VlIGh0dHBzOi8vbmctbW9ja3Muc3Vkby5ldS9hcGkvTW9ja1JlbmRlciNmYWN0b3J5XG4gKi9cbmZ1bmN0aW9uIE1vY2tSZW5kZXJGYWN0b3J5PE1Db21wb25lbnQ+KFxuICB0ZW1wbGF0ZTogSW5qZWN0aW9uVG9rZW48TUNvbXBvbmVudD4sXG4gIGJpbmRpbmdzPzogdW5kZWZpbmVkIHwgbnVsbCxcbiAgb3B0aW9ucz86IElNb2NrUmVuZGVyRmFjdG9yeU9wdGlvbnMsXG4pOiBNb2NrUmVuZGVyRmFjdG9yeTxNQ29tcG9uZW50LCBuZXZlcj47XG5cbi8qKlxuICogQHNlZSBodHRwczovL25nLW1vY2tzLnN1ZG8uZXUvYXBpL01vY2tSZW5kZXIjZmFjdG9yeVxuICovXG5mdW5jdGlvbiBNb2NrUmVuZGVyRmFjdG9yeTxNQ29tcG9uZW50PihcbiAgdGVtcGxhdGU6IEFueVR5cGU8TUNvbXBvbmVudD4sXG4gIGJpbmRpbmdzOiB1bmRlZmluZWQgfCBudWxsLFxuICBvcHRpb25zPzogSU1vY2tSZW5kZXJGYWN0b3J5T3B0aW9ucyxcbik6IE1vY2tSZW5kZXJGYWN0b3J5PE1Db21wb25lbnQsIGtleW9mIE1Db21wb25lbnQ+O1xuXG4vKipcbiAqIEBzZWUgaHR0cHM6Ly9uZy1tb2Nrcy5zdWRvLmV1L2FwaS9Nb2NrUmVuZGVyI2ZhY3RvcnlcbiAqL1xuZnVuY3Rpb24gTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwgVEtleXMgZXh0ZW5kcyBrZXlvZiBhbnk+KFxuICB0ZW1wbGF0ZTogQW55VHlwZTxNQ29tcG9uZW50PixcbiAgYmluZGluZ3M6IFRLZXlzW10sXG4gIG9wdGlvbnM/OiBJTW9ja1JlbmRlckZhY3RvcnlPcHRpb25zLFxuKTogTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwgVEtleXM+O1xuXG4vKipcbiAqIEBzZWUgaHR0cHM6Ly9uZy1tb2Nrcy5zdWRvLmV1L2FwaS9Nb2NrUmVuZGVyI2ZhY3RvcnlcbiAqL1xuZnVuY3Rpb24gTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwgVEtleXMgZXh0ZW5kcyBrZXlvZiBhbnkgPSBrZXlvZiBhbnk+KFxuICB0ZW1wbGF0ZTogQW55VHlwZTxNQ29tcG9uZW50PixcbiAgYmluZGluZ3M6IFRLZXlzW10sXG4gIG9wdGlvbnM/OiBJTW9ja1JlbmRlckZhY3RvcnlPcHRpb25zLFxuKTogTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwgVEtleXM+O1xuXG4vKipcbiAqIFdpdGhvdXQgcGFyYW1zIHdlIHNob3VsZCBub3QgYXV0b2NvbXBsZXRlIGFueSBrZXlzIG9mIGFueSB0eXBlcy5cbiAqXG4gKiBAc2VlIGh0dHBzOi8vbmctbW9ja3Muc3Vkby5ldS9hcGkvTW9ja1JlbmRlciNmYWN0b3J5XG4gKi9cbmZ1bmN0aW9uIE1vY2tSZW5kZXJGYWN0b3J5PE1Db21wb25lbnQ+KHRlbXBsYXRlOiBBbnlUeXBlPE1Db21wb25lbnQ+KTogTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwga2V5b2YgTUNvbXBvbmVudD47XG5cbi8qKlxuICogQW4gZW1wdHkgc3RyaW5nIGRvZXMgbm90IGhhdmUgcG9pbnQuXG4gKlxuICogQHNlZSBodHRwczovL25nLW1vY2tzLnN1ZG8uZXUvYXBpL01vY2tSZW5kZXIjZmFjdG9yeVxuICovXG5mdW5jdGlvbiBNb2NrUmVuZGVyRmFjdG9yeSh0ZW1wbGF0ZTogJycpOiBNb2NrUmVuZGVyRmFjdG9yeTx2b2lkLCBuZXZlcj47XG5cbi8qKlxuICogV2l0aG91dCBwYXJhbXMgd2Ugc2hvdWxkIG5vdCBhdXRvY29tcGxldGUgYW55IGtleXMgb2YgYW55IHR5cGVzLlxuICpcbiAqIEBzZWUgaHR0cHM6Ly9uZy1tb2Nrcy5zdWRvLmV1L2FwaS9Nb2NrUmVuZGVyI2ZhY3RvcnlcbiAqL1xuZnVuY3Rpb24gTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCA9IHZvaWQ+KHRlbXBsYXRlOiBzdHJpbmcpOiBNb2NrUmVuZGVyRmFjdG9yeTxNQ29tcG9uZW50PjtcblxuLyoqXG4gKiBAc2VlIGh0dHBzOi8vbmctbW9ja3Muc3Vkby5ldS9hcGkvTW9ja1JlbmRlciNmYWN0b3J5XG4gKi9cbmZ1bmN0aW9uIE1vY2tSZW5kZXJGYWN0b3J5PE1Db21wb25lbnQgPSB2b2lkLCBUS2V5cyBleHRlbmRzIGtleW9mIGFueSA9IGtleW9mIGFueT4oXG4gIHRlbXBsYXRlOiBzdHJpbmcsXG4gIGJpbmRpbmdzOiBUS2V5c1tdLFxuICBvcHRpb25zPzogSU1vY2tSZW5kZXJGYWN0b3J5T3B0aW9ucyxcbik6IE1vY2tSZW5kZXJGYWN0b3J5PE1Db21wb25lbnQsIFRLZXlzPjtcblxuZnVuY3Rpb24gTW9ja1JlbmRlckZhY3Rvcnk8TUNvbXBvbmVudCwgVEtleXMgZXh0ZW5kcyBzdHJpbmc+KFxuICB0ZW1wbGF0ZTogc3RyaW5nIHwgQW55VHlwZTxNQ29tcG9uZW50PiB8IEluamVjdGlvblRva2VuPE1Db21wb25lbnQ+LFxuICBiaW5kaW5ncz86IHVuZGVmaW5lZCB8IG51bGwgfCBUS2V5c1tdLFxuICBvcHRpb25zOiBJTW9ja1JlbmRlckZhY3RvcnlPcHRpb25zID0ge30sXG4pOiBhbnkge1xuICBmdW5jSW1wb3J0RXhpc3RzKHRlbXBsYXRlLCAnTW9ja1JlbmRlcicpO1xuXG4gIGNvbnN0IG1ldGE6IERpcmVjdGl2ZSA9IHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycgfHwgaXNOZ0RlZih0ZW1wbGF0ZSwgJ3QnKSA/IHt9IDogZnVuY1JlZmxlY3RUZW1wbGF0ZSh0ZW1wbGF0ZSk7XG4gIGNvbnN0IGNvbXBvbmVudEN0b3I6IGFueSA9IGZ1bmNDcmVhdGVXcmFwcGVyKHRlbXBsYXRlLCBtZXRhLCBiaW5kaW5ncywgb3B0aW9ucyk7XG4gIGNvbnN0IGZhY3RvcnkgPSBnZW5lcmF0ZUZhY3RvcnkoY29tcG9uZW50Q3RvciwgYmluZGluZ3MsIHRlbXBsYXRlLCBvcHRpb25zKTtcbiAgaWYgKG5nTW9ja3NTdGFjay5jdXJyZW50KCkubGV2ZWwgIT09ICdyb290JyAmJiBvcHRpb25zLmNvbmZpZ3VyZVRlc3RCZWQgIT09IGZhbHNlKSB7XG4gICAgZmFjdG9yeS5jb25maWd1cmVUZXN0QmVkKCk7XG4gIH1cblxuICByZXR1cm4gZmFjdG9yeTtcbn1cblxuZXhwb3J0IHsgTW9ja1JlbmRlckZhY3RvcnkgfTtcbiJdfQ==