"use strict";
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_helpers_1 = require("../common/core.helpers");
var core_reflect_module_resolve_1 = __importDefault(require("../common/core.reflect.module-resolve"));
var func_get_provider_1 = __importDefault(require("../common/func.get-provider"));
var func_is_ng_def_1 = require("../common/func.is-ng-def");
var func_is_ng_injection_token_1 = require("../common/func.is-ng-injection-token");
var func_is_ng_module_def_with_providers_1 = require("../common/func.is-ng-module-def-with-providers");
var ng_mocks_universe_1 = __importDefault(require("../common/ng-mocks-universe"));
var mock_component_1 = require("../mock-component/mock-component");
var mock_directive_1 = require("../mock-directive/mock-directive");
var mock_module_1 = require("../mock-module/mock-module");
var mock_pipe_1 = require("../mock-pipe/mock-pipe");
var mock_provider_1 = __importDefault(require("../mock-service/mock-provider"));
var skipDef = function (def, skip, exclude) {
    if (skip.has(def)) {
        return true;
    }
    skip.add(def);
    return exclude.has(def);
};
var createMetaHandler = function (optional, proto, imports, declarations, providers) {
    var def = optional.get(proto) || proto;
    if ((0, func_is_ng_def_1.isNgDef)(def, 'm')) {
        imports.push(def);
    }
    else if ((0, func_is_ng_def_1.isNgDef)(def, 'c') || (0, func_is_ng_def_1.isNgDef)(def, 'd')) {
        declarations.push(def);
    }
    else if ((0, func_is_ng_def_1.isNgDef)(def, 'p')) {
        declarations.push(def);
        providers.push(def);
    }
    else if (!(0, func_is_ng_injection_token_1.isNgInjectionToken)(def)) {
        providers.push(def);
    }
};
var createMeta = function (_a) {
    var e_1, _b;
    var keep = _a.keep, skip = _a.skip, optional = _a.optional, exclude = _a.exclude, imports = _a.imports, declarations = _a.declarations, providers = _a.providers;
    try {
        for (var keep_1 = __values(keep), keep_1_1 = keep_1.next(); !keep_1_1.done; keep_1_1 = keep_1.next()) {
            var proto = keep_1_1.value;
            if (skip.has(proto) || exclude.has(proto) || optional.has(proto)) {
                continue;
            }
            createMetaHandler(optional, proto, imports, declarations, providers);
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (keep_1_1 && !keep_1_1.done && (_b = keep_1.return)) _b.call(keep_1);
        }
        finally { if (e_1) throw e_1.error; }
    }
    return { declarations: declarations, imports: imports, providers: providers };
};
var typeMap = [
    ['m', 'module'],
    ['c', 'component'],
    ['d', 'directive'],
    ['p', 'pipe'],
];
var getType = function (def, keep) {
    var e_2, _a;
    if ((0, func_is_ng_module_def_with_providers_1.isNgModuleDefWithProviders)(def)) {
        return 'module-with-providers';
    }
    try {
        for (var typeMap_1 = __values(typeMap), typeMap_1_1 = typeMap_1.next(); !typeMap_1_1.done; typeMap_1_1 = typeMap_1.next()) {
            var _b = __read(typeMap_1_1.value, 2), flag = _b[0], value = _b[1];
            if ((0, func_is_ng_def_1.isNgDef)(def, flag)) {
                return flag === 'm' && keep.has(def) ? value + "-keep" : value;
            }
        }
    }
    catch (e_2_1) { e_2 = { error: e_2_1 }; }
    finally {
        try {
            if (typeMap_1_1 && !typeMap_1_1.done && (_a = typeMap_1.return)) _a.call(typeMap_1);
        }
        finally { if (e_2) throw e_2.error; }
    }
    return '';
};
var handleModuleWithProviders = function (data, def) {
    if (data.skip.has(def.ngModule)) {
        return;
    }
    data.skip.add(def.ngModule);
    if (data.exclude.has(def.ngModule)) {
        return;
    }
    data.imports.push(data.keep.has(def.ngModule) ? def : (0, mock_module_1.MockModule)(def));
};
var handleDeclaration = function (data, def, callback, bucket) {
    if (skipDef(def, data.skip, data.exclude)) {
        return;
    }
    bucket.push(data.keep.has(def) ? def : callback(def));
};
var handleDestructuring = function (data, def, callback) {
    var e_3, _a, e_4, _b;
    if (skipDef(def, data.skip, data.exclude)) {
        return;
    }
    var meta = (0, core_reflect_module_resolve_1.default)(def);
    try {
        for (var _c = __values((0, core_helpers_1.flatten)([meta.declarations, meta.imports])), _d = _c.next(); !_d.done; _d = _c.next()) {
            var toMock = _d.value;
            callback(data, toMock);
        }
    }
    catch (e_3_1) { e_3 = { error: e_3_1 }; }
    finally {
        try {
            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
        }
        finally { if (e_3) throw e_3.error; }
    }
    try {
        for (var _e = __values(meta.providers ? (0, core_helpers_1.flatten)(meta.providers) : []), _f = _e.next(); !_f.done; _f = _e.next()) {
            var toMock = _f.value;
            resolveProvider(data, toMock);
        }
    }
    catch (e_4_1) { e_4 = { error: e_4_1 }; }
    finally {
        try {
            if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
        }
        finally { if (e_4) throw e_4.error; }
    }
};
var resolveProvider = function (_a, def) {
    var skip = _a.skip, keep = _a.keep, providers = _a.providers, exclude = _a.exclude;
    var provider = (0, func_get_provider_1.default)(def);
    skip.add(provider);
    if (exclude.has(provider)) {
        return;
    }
    var providerDef = keep.has(provider) ? def : (0, mock_provider_1.default)(def);
    if (providerDef) {
        providers.push(providerDef);
    }
};
var resolveMap = {
    component: mock_component_1.MockComponent,
    directive: mock_directive_1.MockDirective,
    pipe: mock_pipe_1.MockPipe,
};
var resolveHandler = function (data, type, def, skipDestruction) {
    if (type === 'module-with-providers') {
        handleModuleWithProviders(data, def);
    }
    else if (type === 'module-keep') {
        handleDeclaration(data, def, mock_module_1.MockModule, data.imports); // MockModule will not be called because the def is kept.
    }
    else if (type === 'module' && skipDestruction) {
        handleDeclaration(data, def, mock_module_1.MockModule, data.imports);
    }
    else if (type === 'module') {
        handleDestructuring(data, def, resolve);
    }
    else if (resolveMap[type]) {
        handleDeclaration(data, def, resolveMap[type], data.declarations);
    }
    else {
        resolveProvider(data, def);
    }
};
var resolve = function (data, proto, skipDestruction) {
    if (skipDestruction === void 0) { skipDestruction = true; }
    if (!proto) {
        return;
    }
    var type = getType(proto, data.keep);
    var def;
    // an attempt to replace declarations.
    if (type !== 'module-with-providers') {
        var value = data.optional.get(proto);
        if (value && value !== proto) {
            def = value;
            data.keep.add(def);
        }
    }
    if (!def) {
        def = proto;
    }
    resolveHandler(data, type, def, skipDestruction);
};
var generateDataWithUniverse = function (keep, mock, exclude, optional) {
    var e_5, _a;
    try {
        for (var _b = __values((0, core_helpers_1.mapKeys)(ng_mocks_universe_1.default.getDefaults())), _c = _b.next(); !_c.done; _c = _b.next()) {
            var k = _c.value;
            var v = ng_mocks_universe_1.default.getBuildDeclaration(k);
            if (keep.has(k) || mock.has(k) || exclude.has(k)) {
                continue;
            }
            optional.set(k, v);
            if (v === null) {
                exclude.add(k);
            }
            else if (v === undefined) {
                mock.add(k);
            }
            else if (k === v) {
                keep.add(k);
            }
        }
    }
    catch (e_5_1) { e_5 = { error: e_5_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_5) throw e_5.error; }
    }
};
var generateData = function (protoKeep, protoMock, protoExclude) {
    var keep = new Set((0, core_helpers_1.flatten)(protoKeep || []));
    var mock = new Set((0, core_helpers_1.flatten)(protoMock || []));
    var exclude = new Set((0, core_helpers_1.flatten)(protoExclude || []));
    var optional = new Map();
    generateDataWithUniverse(keep, mock, exclude, optional);
    return {
        declarations: [],
        exclude: exclude,
        imports: [],
        keep: keep,
        mock: mock,
        optional: optional,
        providers: [],
        skip: new Set(),
    };
};
exports.default = (function (keep, mock, exclude) {
    var e_6, _a, e_7, _b, e_8, _c;
    if (mock === void 0) { mock = null; }
    if (exclude === void 0) { exclude = null; }
    var data = generateData(keep, mock, exclude);
    var resolutions = new Map();
    ng_mocks_universe_1.default.config.set('ngMocksDepsResolution', resolutions);
    try {
        for (var _d = __values((0, core_helpers_1.mapValues)(data.keep)), _e = _d.next(); !_e.done; _e = _d.next()) {
            var mockDef = _e.value;
            resolutions.set(mockDef, 'keep');
        }
    }
    catch (e_6_1) { e_6 = { error: e_6_1 }; }
    finally {
        try {
            if (_e && !_e.done && (_a = _d.return)) _a.call(_d);
        }
        finally { if (e_6) throw e_6.error; }
    }
    try {
        for (var _f = __values((0, core_helpers_1.mapValues)(data.exclude)), _g = _f.next(); !_g.done; _g = _f.next()) {
            var mockDef = _g.value;
            resolutions.set(mockDef, 'exclude');
        }
    }
    catch (e_7_1) { e_7 = { error: e_7_1 }; }
    finally {
        try {
            if (_g && !_g.done && (_b = _f.return)) _b.call(_f);
        }
        finally { if (e_7) throw e_7.error; }
    }
    ng_mocks_universe_1.default.config.set('mockNgDefResolver', new Map());
    try {
        for (var _h = __values((0, core_helpers_1.mapValues)(data.mock)), _j = _h.next(); !_j.done; _j = _h.next()) {
            var def = _j.value;
            resolutions.set(def, 'mock');
            if (data.optional.has(def)) {
                continue;
            }
            resolve(data, def, false);
        }
    }
    catch (e_8_1) { e_8 = { error: e_8_1 }; }
    finally {
        try {
            if (_j && !_j.done && (_c = _h.return)) _c.call(_h);
        }
        finally { if (e_8) throw e_8.error; }
    }
    var meta = createMeta(data);
    ng_mocks_universe_1.default.config.delete('mockNgDefResolver');
    ng_mocks_universe_1.default.config.delete('ngMocksDepsResolution');
    return meta;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1oZWxwZXIuZ3V0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmctbW9ja3Mvc3JjL2xpYi9tb2NrLWhlbHBlci9tb2NrLWhlbHBlci5ndXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsdURBQXFFO0FBQ3JFLHNHQUE2RTtBQUM3RSxrRkFBMEQ7QUFDMUQsMkRBQW1EO0FBQ25ELG1GQUEwRTtBQUMxRSx1R0FBNEY7QUFDNUYsa0ZBQTBEO0FBQzFELG1FQUFpRTtBQUNqRSxtRUFBaUU7QUFDakUsMERBQXdEO0FBQ3hELG9EQUFrRDtBQUNsRCxnRkFBeUQ7QUFhekQsSUFBTSxPQUFPLEdBQUcsVUFBQyxHQUFRLEVBQUUsSUFBYyxFQUFFLE9BQWlCO0lBQzFELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNqQixPQUFPLElBQUksQ0FBQztLQUNiO0lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVkLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQixDQUFDLENBQUM7QUFFRixJQUFNLGlCQUFpQixHQUFHLFVBQ3hCLFFBQXVCLEVBQ3ZCLEtBQVUsRUFDVixPQUFjLEVBQ2QsWUFBbUIsRUFDbkIsU0FBZ0I7SUFFaEIsSUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7SUFFekMsSUFBSSxJQUFBLHdCQUFPLEVBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFO1FBQ3JCLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbkI7U0FBTSxJQUFJLElBQUEsd0JBQU8sRUFBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBQSx3QkFBTyxFQUFDLEdBQUcsRUFBRSxH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QkFBQSw0QkFBRTtZQUExQyxJQUFNLE9BQU8sV0FBQTtZQUNoQixXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztTQUNyQzs7Ozs7Ozs7O0lBRUQsMkJBQWUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBQzs7UUFDM0QsS0FBa0IsSUFBQSxLQUFBLFNBQUEsSUFBQSx3QkFBUyxFQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQSxnQkFBQSw0QkFBRTtZQUFuQyxJQUFNLEdBQUcsV0FBQTtZQUNaLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzdCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzFCLFNBQVM7YUFDVjtZQUNELE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNCOzs7Ozs7Ozs7SUFDRCxJQUFNLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUIsMkJBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDbkQsMkJBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFFdkQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0TW9kdWxlTWV0YWRhdGEgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xuXG5pbXBvcnQgeyBmbGF0dGVuLCBtYXBLZXlzLCBtYXBWYWx1ZXMgfSBmcm9tICcuLi9jb21tb24vY29yZS5oZWxwZXJzJztcbmltcG9ydCBjb3JlUmVmbGVjdE1vZHVsZVJlc29sdmUgZnJvbSAnLi4vY29tbW9uL2NvcmUucmVmbGVjdC5tb2R1bGUtcmVzb2x2ZSc7XG5pbXBvcnQgZnVuY0dldFByb3ZpZGVyIGZyb20gJy4uL2NvbW1vbi9mdW5jLmdldC1wcm92aWRlcic7XG5pbXBvcnQgeyBpc05nRGVmIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctZGVmJztcbmltcG9ydCB7IGlzTmdJbmplY3Rpb25Ub2tlbiB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmlzLW5nLWluamVjdGlvbi10b2tlbic7XG5pbXBvcnQgeyBpc05nTW9kdWxlRGVmV2l0aFByb3ZpZGVycyB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmlzLW5nLW1vZHVsZS1kZWYtd2l0aC1wcm92aWRlcnMnO1xuaW1wb3J0IG5nTW9ja3NVbml2ZXJzZSBmcm9tICcuLi9jb21tb24vbmctbW9ja3MtdW5pdmVyc2UnO1xuaW1wb3J0IHsgTW9ja0NvbXBvbmVudCB9IGZyb20gJy4uL21vY2stY29tcG9uZW50L21vY2stY29tcG9uZW50JztcbmltcG9ydCB7IE1vY2tEaXJlY3RpdmUgfSBmcm9tICcuLi9tb2NrLWRpcmVjdGl2ZS9tb2NrLWRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBNb2NrTW9kdWxlIH0gZnJvbSAnLi4vbW9jay1tb2R1bGUvbW9jay1tb2R1bGUnO1xuaW1wb3J0IHsgTW9ja1BpcGUgfSBmcm9tICcuLi9tb2NrLXBpcGUvbW9jay1waXBlJztcbmltcG9ydCBtb2NrUHJvdmlkZXIgZnJvbSAnLi4vbW9jay1zZXJ2aWNlL21vY2stcHJvdmlkZXInO1xuXG50eXBlIERhdGEgPSB7XG4gIGRlY2xhcmF0aW9uczogYW55W107XG4gIGV4Y2x1ZGU6IFNldDxhbnk+O1xuICBpbXBvcnRzOiBhbnlbXTtcbiAga2VlcDogU2V0PGFueT47XG4gIG1vY2s6IFNldDxhbnk+O1xuICBvcHRpb25hbDogTWFwPGFueSwgYW55PjtcbiAgcHJvdmlkZXJzOiBhbnlbXTtcbiAgc2tpcDogU2V0PGFueT47XG59O1xuXG5jb25zdCBza2lwRGVmID0gKGRlZjogYW55LCBza2lwOiBTZXQ8YW55PiwgZXhjbHVkZTogU2V0PGFueT4pOiBib29sZWFuID0+IHtcbiAgaWYgKHNraXAuaGFzKGRlZikpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBza2lwLmFkZChkZWYpO1xuXG4gIHJldHVybiBleGNsdWRlLmhhcyhkZWYpO1xufTtcblxuY29uc3QgY3JlYXRlTWV0YUhhbmRsZXIgPSAoXG4gIG9wdGlvbmFsOiBNYXA8YW55LCBhbnk+LFxuICBwcm90bzogYW55LFxuICBpbXBvcnRzOiBhbnlbXSxcbiAgZGVjbGFyYXRpb25zOiBhbnlbXSxcbiAgcHJvdmlkZXJzOiBhbnlbXSxcbik6IHZvaWQgPT4ge1xuICBjb25zdCBkZWYgPSBvcHRpb25hbC5nZXQocHJvdG8pIHx8IHByb3RvO1xuXG4gIGlmIChpc05nRGVmKGRlZiwgJ20nKSkge1xuICAgIGltcG9ydHMucHVzaChkZWYpO1xuICB9IGVsc2UgaWYgKGlzTmdEZWYoZGVmLCAnYycpIHx8IGlzTmdEZWYoZGVmLCAnZCcpKSB7XG4gICAgZGVjbGFyYXRpb25zLnB1c2goZGVmKTtcbiAgfSBlbHNlIGlmIChpc05nRGVmKGRlZiwgJ3AnKSkge1xuICAgIGRlY2xhcmF0aW9ucy5wdXNoKGRlZik7XG4gICAgcHJvdmlkZXJzLnB1c2goZGVmKTtcbiAgfSBlbHNlIGlmICghaXNOZ0luamVjdGlvblRva2VuKGRlZikpIHtcbiAgICBwcm92aWRlcnMucHVzaChkZWYpO1xuICB9XG59O1xuXG5jb25zdCBjcmVhdGVNZXRhID0gKHsga2VlcCwgc2tpcCwgb3B0aW9uYWwsIGV4Y2x1ZGUsIGltcG9ydHMsIGRlY2xhcmF0aW9ucywgcHJvdmlkZXJzIH06IERhdGEpOiBUZXN0TW9kdWxlTWV0YWRhdGEgPT4ge1xuICBmb3IgKGNvbnN0IHByb3RvIG9mIGtlZXApIHtcbiAgICBpZiAoc2tpcC5oYXMocHJvdG8pIHx8IGV4Y2x1ZGUuaGFzKHByb3RvKSB8fCBvcHRpb25hbC5oYXMocHJvdG8pKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgY3JlYXRlTWV0YUhhbmRsZXIob3B0aW9uYWwsIHByb3RvLCBpbXBvcnRzLCBkZWNsYXJhdGlvbnMsIHByb3ZpZGVycyk7XG4gIH1cblxuICByZXR1cm4geyBkZWNsYXJhdGlvbnMsIGltcG9ydHMsIHByb3ZpZGVycyB9O1xufTtcblxuY29uc3QgdHlwZU1hcDogQXJyYXk8W2FueSwgc3RyaW5nXT4gPSBbXG4gIFsnbScsICdtb2R1bGUnXSxcbiAgWydjJywgJ2NvbXBvbmVudCddLFxuICBbJ2QnLCAnZGlyZWN0aXZlJ10sXG4gIFsncCcsICdwaXBlJ10sXG5dO1xuXG5jb25zdCBnZXRUeXBlID0gKGRlZjogYW55LCBrZWVwOiBTZXQ8YW55Pik6IHN0cmluZyA9PiB7XG4gIGlmIChpc05nTW9kdWxlRGVmV2l0aFByb3ZpZGVycyhkZWYpKSB7XG4gICAgcmV0dXJuICdtb2R1bGUtd2l0aC1wcm92aWRlcnMnO1xuICB9XG4gIGZvciAoY29uc3QgW2ZsYWcsIHZhbHVlXSBvZiB0eXBlTWFwKSB7XG4gICAgaWYgKGlzTmdEZWYoZGVmLCBmbGFnKSkge1xuICAgICAgcmV0dXJuIGZsYWcgPT09ICdtJyAmJiBrZWVwLmhhcyhkZWYpID8gYCR7dmFsdWV9LWtlZXBgIDogdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuICcnO1xufTtcblxuY29uc3QgaGFuZGxlTW9kdWxlV2l0aFByb3ZpZGVycyA9IChkYXRhOiBEYXRhLCBkZWY6IGFueSk6IHZvaWQgPT4ge1xuICBpZiAoZGF0YS5za2lwLmhhcyhkZWYubmdNb2R1bGUpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGRhdGEuc2tpcC5hZGQoZGVmLm5nTW9kdWxlKTtcbiAgaWYgKGRhdGEuZXhjbHVkZS5oYXMoZGVmLm5nTW9kdWxlKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGRhdGEuaW1wb3J0cy5wdXNoKGRhdGEua2VlcC5oYXMoZGVmLm5nTW9kdWxlKSA/IGRlZiA6IE1vY2tNb2R1bGUoZGVmKSk7XG59O1xuXG5jb25zdCBoYW5kbGVEZWNsYXJhdGlvbiA9IChkYXRhOiBEYXRhLCBkZWY6IGFueSwgY2FsbGJhY2s6IGFueSwgYnVja2V0OiBhbnlbXSk6IHZvaWQgPT4ge1xuICBpZiAoc2tpcERlZihkZWYsIGRhdGEuc2tpcCwgZGF0YS5leGNsdWRlKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGJ1Y2tldC5wdXNoKGRhdGEua2VlcC5oYXMoZGVmKSA/IGRlZiA6IGNhbGxiYWNrKGRlZikpO1xufTtcblxuY29uc3QgaGFuZGxlRGVzdHJ1Y3R1cmluZyA9IChkYXRhOiBEYXRhLCBkZWY6IGFueSwgY2FsbGJhY2s6IGFueSk6IHZvaWQgPT4ge1xuICBpZiAoc2tpcERlZihkZWYsIGRhdGEuc2tpcCwgZGF0YS5leGNsdWRlKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IG1ldGEgPSBjb3JlUmVmbGVjdE1vZHVsZVJlc29sdmUoZGVmKTtcbiAgZm9yIChjb25zdCB0b01vY2sgb2YgZmxhdHRlbihbbWV0YS5kZWNsYXJhdGlvbnMsIG1ldGEuaW1wb3J0c10pKSB7XG4gICAgY2FsbGJhY2soZGF0YSwgdG9Nb2NrKTtcbiAgfVxuICBmb3IgKGNvbnN0IHRvTW9jayBvZiBtZXRhLnByb3ZpZGVycyA/IGZsYXR0ZW4obWV0YS5wcm92aWRlcnMpIDogW10pIHtcbiAgICByZXNvbHZlUHJvdmlkZXIoZGF0YSwgdG9Nb2NrKTtcbiAgfVxufTtcblxuY29uc3QgcmVzb2x2ZVByb3ZpZGVyID0gKHsgc2tpcCwga2VlcCwgcHJvdmlkZXJzLCBleGNsdWRlIH06IERhdGEsIGRlZjogYW55KTogdm9pZCA9PiB7XG4gIGNvbnN0IHByb3ZpZGVyID0gZnVuY0dldFByb3ZpZGVyKGRlZik7XG4gIHNraXAuYWRkKHByb3ZpZGVyKTtcbiAgaWYgKGV4Y2x1ZGUuaGFzKHByb3ZpZGVyKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHByb3ZpZGVyRGVmID0ga2VlcC5oYXMocHJvdmlkZXIpID8gZGVmIDogbW9ja1Byb3ZpZGVyKGRlZik7XG4gIGlmIChwcm92aWRlckRlZikge1xuICAgIHByb3ZpZGVycy5wdXNoKHByb3ZpZGVyRGVmKTtcbiAgfVxufTtcblxuY29uc3QgcmVzb2x2ZU1hcDogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgY29tcG9uZW50OiBNb2NrQ29tcG9uZW50LFxuICBkaXJlY3RpdmU6IE1vY2tEaXJlY3RpdmUsXG4gIHBpcGU6IE1vY2tQaXBlLFxufTtcblxuY29uc3QgcmVzb2x2ZUhhbmRsZXIgPSAoZGF0YTogRGF0YSwgdHlwZTogc3RyaW5nLCBkZWY6IGFueSwgc2tpcERlc3RydWN0aW9uOiBib29sZWFuKTogdm9pZCA9PiB7XG4gIGlmICh0eXBlID09PSAnbW9kdWxlLXdpdGgtcHJvdmlkZXJzJykge1xuICAgIGhhbmRsZU1vZHVsZVdpdGhQcm92aWRlcnMoZGF0YSwgZGVmKTtcbiAgfSBlbHNlIGlmICh0eXBlID09PSAnbW9kdWxlLWtlZXAnKSB7XG4gICAgaGFuZGxlRGVjbGFyYXRpb24oZGF0YSwgZGVmLCBNb2NrTW9kdWxlLCBkYXRhLmltcG9ydHMpOyAvLyBNb2NrTW9kdWxlIHdpbGwgbm90IGJlIGNhbGxlZCBiZWNhdXNlIHRoZSBkZWYgaXMga2VwdC5cbiAgfSBlbHNlIGlmICh0eXBlID09PSAnbW9kdWxlJyAmJiBza2lwRGVzdHJ1Y3Rpb24pIHtcbiAgICBoYW5kbGVEZWNsYXJhdGlvbihkYXRhLCBkZWYsIE1vY2tNb2R1bGUsIGRhdGEuaW1wb3J0cyk7XG4gIH0gZWxzZSBpZiAodHlwZSA9PT0gJ21vZHVsZScpIHtcbiAgICBoYW5kbGVEZXN0cnVjdHVyaW5nKGRhdGEsIGRlZiwgcmVzb2x2ZSk7XG4gIH0gZWxzZSBpZiAocmVzb2x2ZU1hcFt0eXBlXSkge1xuICAgIGhhbmRsZURlY2xhcmF0aW9uKGRhdGEsIGRlZiwgcmVzb2x2ZU1hcFt0eXBlXSwgZGF0YS5kZWNsYXJhdGlvbnMpO1xuICB9IGVsc2Uge1xuICAgIHJlc29sdmVQcm92aWRlcihkYXRhLCBkZWYpO1xuICB9XG59O1xuXG5jb25zdCByZXNvbHZlID0gKGRhdGE6IERhdGEsIHByb3RvOiBhbnksIHNraXBEZXN0cnVjdGlvbiA9IHRydWUpOiB2b2lkID0+IHtcbiAgaWYgKCFwcm90bykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHR5cGUgPSBnZXRUeXBlKHByb3RvLCBkYXRhLmtlZXApO1xuICBsZXQgZGVmOiBhbnk7XG5cbiAgLy8gYW4gYXR0ZW1wdCB0byByZXBsYWNlIGRlY2xhcmF0aW9ucy5cbiAgaWYgKHR5cGUgIT09ICdtb2R1bGUtd2l0aC1wcm92aWRlcnMnKSB7XG4gICAgY29uc3QgdmFsdWUgPSBkYXRhLm9wdGlvbmFsLmdldChwcm90byk7XG4gICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSBwcm90bykge1xuICAgICAgZGVmID0gdmFsdWU7XG4gICAgICBkYXRhLmtlZXAuYWRkKGRlZik7XG4gICAgfVxuICB9XG4gIGlmICghZGVmKSB7XG4gICAgZGVmID0gcHJvdG87XG4gIH1cblxuICByZXNvbHZlSGFuZGxlcihkYXRhLCB0eXBlLCBkZWYsIHNraXBEZXN0cnVjdGlvbik7XG59O1xuXG5jb25zdCBnZW5lcmF0ZURhdGFXaXRoVW5pdmVyc2UgPSAoa2VlcDogU2V0PGFueT4sIG1vY2s6IFNldDxhbnk+LCBleGNsdWRlOiBTZXQ8YW55Piwgb3B0aW9uYWw6IE1hcDxhbnksIGFueT4pOiB2b2lkID0+IHtcbiAgZm9yIChjb25zdCBrIG9mIG1hcEtleXMobmdNb2Nrc1VuaXZlcnNlLmdldERlZmF1bHRzKCkpKSB7XG4gICAgY29uc3QgdiA9IG5nTW9ja3NVbml2ZXJzZS5nZXRCdWlsZERlY2xhcmF0aW9uKGspO1xuICAgIGlmIChrZWVwLmhhcyhrKSB8fCBtb2NrLmhhcyhrKSB8fCBleGNsdWRlLmhhcyhrKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIG9wdGlvbmFsLnNldChrLCB2KTtcblxuICAgIGlmICh2ID09PSBudWxsKSB7XG4gICAgICBleGNsdWRlLmFkZChrKTtcbiAgICB9IGVsc2UgaWYgKHYgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbW9jay5hZGQoayk7XG4gICAgfSBlbHNlIGlmIChrID09PSB2KSB7XG4gICAgICBrZWVwLmFkZChrKTtcbiAgICB9XG4gIH1cbn07XG5cbmNvbnN0IGdlbmVyYXRlRGF0YSA9IChwcm90b0tlZXA6IGFueSwgcHJvdG9Nb2NrOiBhbnksIHByb3RvRXhjbHVkZTogYW55KTogRGF0YSA9PiB7XG4gIGNvbnN0IGtlZXAgPSBuZXcgU2V0KGZsYXR0ZW4ocHJvdG9LZWVwIHx8IFtdKSk7XG4gIGNvbnN0IG1vY2sgPSBuZXcgU2V0KGZsYXR0ZW4ocHJvdG9Nb2NrIHx8IFtdKSk7XG4gIGNvbnN0IGV4Y2x1ZGUgPSBuZXcgU2V0KGZsYXR0ZW4ocHJvdG9FeGNsdWRlIHx8IFtdKSk7XG4gIGNvbnN0IG9wdGlvbmFsID0gbmV3IE1hcCgpO1xuICBnZW5lcmF0ZURhdGFXaXRoVW5pdmVyc2Uoa2VlcCwgbW9jaywgZXhjbHVkZSwgb3B0aW9uYWwpO1xuXG4gIHJldHVybiB7XG4gICAgZGVjbGFyYXRpb25zOiBbXSxcbiAgICBleGNsdWRlLFxuICAgIGltcG9ydHM6IFtdLFxuICAgIGtlZXAsXG4gICAgbW9jayxcbiAgICBvcHRpb25hbCxcbiAgICBwcm92aWRlcnM6IFtdLFxuICAgIHNraXA6IG5ldyBTZXQoKSxcbiAgfTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IChrZWVwOiBhbnksIG1vY2s6IGFueSA9IG51bGwsIGV4Y2x1ZGU6IGFueSA9IG51bGwpOiBUZXN0TW9kdWxlTWV0YWRhdGEgPT4ge1xuICBjb25zdCBkYXRhOiBEYXRhID0gZ2VuZXJhdGVEYXRhKGtlZXAsIG1vY2ssIGV4Y2x1ZGUpO1xuXG4gIGNvbnN0IHJlc29sdXRpb25zID0gbmV3IE1hcCgpO1xuICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLnNldCgnbmdNb2Nrc0RlcHNSZXNvbHV0aW9uJywgcmVzb2x1dGlvbnMpO1xuICBmb3IgKGNvbnN0IG1vY2tEZWYgb2YgbWFwVmFsdWVzKGRhdGEua2VlcCkpIHtcbiAgICByZXNvbHV0aW9ucy5zZXQobW9ja0RlZiwgJ2tlZXAnKTtcbiAgfVxuICBmb3IgKGNvbnN0IG1vY2tEZWYgb2YgbWFwVmFsdWVzKGRhdGEuZXhjbHVkZSkpIHtcbiAgICByZXNvbHV0aW9ucy5zZXQobW9ja0RlZiwgJ2V4Y2x1ZGUnKTtcbiAgfVxuXG4gIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuc2V0KCdtb2NrTmdEZWZSZXNvbHZlcicsIG5ldyBNYXAoKSk7XG4gIGZvciAoY29uc3QgZGVmIG9mIG1hcFZhbHVlcyhkYXRhLm1vY2spKSB7XG4gICAgcmVzb2x1dGlvbnMuc2V0KGRlZiwgJ21vY2snKTtcbiAgICBpZiAoZGF0YS5vcHRpb25hbC5oYXMoZGVmKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIHJlc29sdmUoZGF0YSwgZGVmLCBmYWxzZSk7XG4gIH1cbiAgY29uc3QgbWV0YSA9IGNyZWF0ZU1ldGEoZGF0YSk7XG4gIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZGVsZXRlKCdtb2NrTmdEZWZSZXNvbHZlcicpO1xuICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLmRlbGV0ZSgnbmdNb2Nrc0RlcHNSZXNvbHV0aW9uJyk7XG5cbiAgcmV0dXJuIG1ldGE7XG59O1xuIl19