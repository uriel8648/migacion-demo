"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockComponent = exports.MockComponents = void 0;
var core_1 = require("@angular/core");
var testing_1 = require("@angular/core/testing");
var core_define_property_1 = __importDefault(require("../common/core.define-property"));
var core_form_1 = __importDefault(require("../common/core.form"));
var core_helpers_1 = require("../common/core.helpers");
var core_reflect_directive_resolve_1 = __importDefault(require("../common/core.reflect.directive-resolve"));
var func_get_mocked_ng_def_of_1 = require("../common/func.get-mocked-ng-def-of");
var func_import_exists_1 = __importDefault(require("../common/func.import-exists"));
var func_is_mock_1 = __importDefault(require("../common/func.is-mock"));
var func_is_mock_ng_def_1 = require("../common/func.is-mock-ng-def");
var mock_control_value_accessor_1 = require("../common/mock-control-value-accessor");
var ng_mocks_universe_1 = __importDefault(require("../common/ng-mocks-universe"));
var decorate_declaration_1 = __importDefault(require("../mock/decorate-declaration"));
var generate_template_1 = __importDefault(require("./render/generate-template"));
var get_key_1 = __importDefault(require("./render/get-key"));
var mixRenderPrepareVcr = function (instance, type, selector, cdr) {
    if (!instance["ngMocksRender_" + type + "_" + selector]) {
        instance["ngMocksRender_" + type + "_" + selector] = true;
        cdr.detectChanges();
    }
    return instance["__mockView_" + type + "_" + selector];
};
var mixRenderReorderViews = function (viewContainer, views, index) {
    var e_1, _a, e_2, _b;
    try {
        for (var _c = __values(views.splice(index + 1)), _d = _c.next(); !_d.done; _d = _c.next()) {
            var view = _d.value;
            view.destroy();
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
        }
        finally { if (e_1) throw e_1.error; }
    }
    var viewIndex = 0;
    try {
        for (var views_1 = __values(views), views_1_1 = views_1.next(); !views_1_1.done; views_1_1 = views_1.next()) {
            var view = views_1_1.value;
            if (!view) {
                continue;
            }
            viewContainer.move(view, viewIndex);
            viewIndex += 1;
        }
    }
    catch (e_2_1) { e_2 = { error: e_2_1 }; }
    finally {
        try {
            if (views_1_1 && !views_1_1.done && (_b = views_1.return)) _b.call(views_1);
        }
        finally { if (e_2) throw e_2.error; }
    }
};
var mixRenderApplyContext = function (view, context) {
    var e_3, _a, e_4, _b;
    try {
        for (var _c = __values(Object.keys(view.context)), _d = _c.next(); !_d.done; _d = _c.next()) {
            var contextKey = _d.value;
            view.context[contextKey] = undefined;
        }
    }
    catch (e_3_1) { e_3 = { error: e_3_1 }; }
    finally {
        try {
            if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
        }
        finally { if (e_3) throw e_3.error; }
    }
    try {
        for (var _e = __values(Object.keys(context)), _f = _e.next(); !_f.done; _f = _e.next()) {
            var contextKey = _f.value;
            view.context[contextKey] = context[contextKey];
        }
    }
    catch (e_4_1) { e_4 = { error: e_4_1 }; }
    finally {
        try {
            if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
        }
        finally { if (e_4) throw e_4.error; }
    }
    view.markForCheck();
};
var mixRenderHandleViews = function (vcr, cdr, templates, views, indices, context) {
    var e_5, _a;
    var index = -1;
    try {
        for (var templates_1 = __values(templates), templates_1_1 = templates_1.next(); !templates_1_1.done; templates_1_1 = templates_1.next()) {
            var templateRef = templates_1_1.value;
            index += 1;
            views[index] = views[index] || undefined;
            if ((indices && indices.indexOf(index) === -1) || !templateRef) {
                continue;
            }
            if (!(templateRef instanceof core_1.TemplateRef)) {
                throw new Error("Cannot find TemplateRef");
            }
            if (!views[index]) {
                views[index] = vcr.createEmbeddedView(templateRef, {});
            }
            mixRenderApplyContext(views[index], context);
        }
    }
    catch (e_5_1) { e_5 = { error: e_5_1 }; }
    finally {
        try {
            if (templates_1_1 && !templates_1_1.done && (_a = templates_1.return)) _a.call(templates_1);
        }
        finally { if (e_5) throw e_5.error; }
    }
    cdr.detectChanges();
    return index;
};
var mixRender = function (instance, cdr) {
    // Providing a method to render any @ContentChild based on its selector.
    (0, core_define_property_1.default)(instance, '__render', function (contentChildSelector, $implicit, variables) {
        var _a = __read((0, get_key_1.default)(contentChildSelector), 4), type = _a[0], key = _a[1], selector = _a[2], indices = _a[3];
        var vcr = mixRenderPrepareVcr(instance, type, selector, cdr);
        if (!vcr) {
            return;
        }
        var property = instance[key];
        var templates = property instanceof core_1.QueryList ? property.toArray() : [property];
        var views = instance["ngMocksRender_" + type + "_" + selector + "_views"] || [];
        var index = mixRenderHandleViews(vcr, cdr, templates, views, indices, __assign(__assign({}, variables), { $implicit: $implicit }));
        mixRenderReorderViews(vcr, views, index);
        instance["ngMocksRender_" + type + "_" + selector + "_views"] = views;
        cdr.detectChanges();
    });
};
var mixHideHandler = function (instance, type, selector, indices) {
    var e_6, _a;
    var views = instance["ngMocksRender_" + type + "_" + selector + "_views"];
    var index = -1;
    try {
        for (var views_2 = __values(views), views_2_1 = views_2.next(); !views_2_1.done; views_2_1 = views_2.next()) {
            var view = views_2_1.value;
            index += 1;
            if ((indices && indices.indexOf(index) === -1) || !view) {
                continue;
            }
            view.destroy();
            views[index] = undefined;
        }
    }
    catch (e_6_1) { e_6 = { error: e_6_1 }; }
    finally {
        try {
            if (views_2_1 && !views_2_1.done && (_a = views_2.return)) _a.call(views_2);
        }
        finally { if (e_6) throw e_6.error; }
    }
};
var mixHide = function (instance, changeDetector) {
    // Providing method to hide any @ContentChild based on its selector.
    (0, core_define_property_1.default)(instance, '__hide', function (contentChildSelector) {
        var _a = __read((0, get_key_1.default)(contentChildSelector), 4), type = _a[0], selector = _a[2], indices = _a[3];
        if (!instance["ngMocksRender_" + type + "_" + selector]) {
            return;
        }
        mixHideHandler(instance, type, selector, indices);
        if (!indices) {
            instance["ngMocksRender_" + type + "_" + selector] = false;
        }
        changeDetector.detectChanges();
    });
};
var ComponentMockBase = /** @class */ (function (_super) {
    __extends(ComponentMockBase, _super);
    // istanbul ignore next
    function ComponentMockBase(injector, ngControl, // NgControl
    changeDetector) {
        var _this = _super.call(this, injector, ngControl) || this;
        if ((0, func_is_mock_1.default)(_this)) {
            mixRender(_this, changeDetector);
            mixHide(_this, changeDetector);
        }
        return _this;
    }
    ComponentMockBase.prototype.ngAfterContentInit = function () {
        var e_7, _a;
        var config = this.__ngMocksConfig.config;
        if (!this.__rendered && config && config.render) {
            try {
                for (var _b = __values(Object.keys(config.render)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var block = _c.value;
                    var _d = config.render[block] !== true
                        ? config.render[block]
                        : {
                            $implicit: undefined,
                            variables: {},
                        }, $implicit = _d.$implicit, variables = _d.variables;
                    this.__render(block, $implicit, variables);
                }
            }
            catch (e_7_1) { e_7 = { error: e_7_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_7) throw e_7.error; }
            }
            this.__rendered = true;
        }
    };
    return ComponentMockBase;
}(mock_control_value_accessor_1.LegacyControlValueAccessor));
(0, core_define_property_1.default)(ComponentMockBase, 'parameters', [
    [core_1.Injector],
    [core_form_1.default.NgControl || /* istanbul ignore next */ (function () { return undefined; }), new core_1.Optional(), new core_1.Self()],
    [core_1.ChangeDetectorRef],
]);
var decorateClass = function (component, mock) {
    var meta = (0, core_reflect_directive_resolve_1.default)(component);
    var exportAs = meta.exportAs, inputs = meta.inputs, outputs = meta.outputs, queries = meta.queries, selector = meta.selector, providers = meta.providers, viewProviders = meta.viewProviders;
    var template = (0, generate_template_1.default)(queries);
    var mockMeta = { inputs: inputs, outputs: outputs, providers: providers, viewProviders: viewProviders, queries: queries };
    var mockParams = { exportAs: exportAs, selector: selector, template: template };
    (0, core_1.Component)((0, decorate_declaration_1.default)(component, mock, mockMeta, mockParams))(mock);
};
function MockComponents() {
    var components = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        components[_i] = arguments[_i];
    }
    return components.map(MockComponent);
}
exports.MockComponents = MockComponents;
/**
 * @see https://ng-mocks.sudo.eu/api/MockComponent
 */
function MockComponent(component) {
    (0, func_import_exists_1.default)(component, 'MockComponent');
    if ((0, func_is_mock_ng_def_1.isMockNgDef)(component, 'c')) {
        return component;
    }
    // We are inside of an 'it'. It is fine to to return a mock copy.
    if ((0, testing_1.getTestBed)()._instantiated) {
        try {
            return (0, func_get_mocked_ng_def_of_1.getMockedNgDefOf)(component, 'c');
        }
        catch (error) {
            // looks like an in-test mock.
        }
    }
    if (ng_mocks_universe_1.default.flags.has('cacheComponent') && ng_mocks_universe_1.default.cacheDeclarations.has(component)) {
        return ng_mocks_universe_1.default.cacheDeclarations.get(component);
    }
    var mock = (0, core_helpers_1.extendClass)(ComponentMockBase);
    decorateClass(component, mock);
    // istanbul ignore else
    if (ng_mocks_universe_1.default.flags.has('cacheComponent')) {
        ng_mocks_universe_1.default.cacheDeclarations.set(component, mock);
    }
    return mock;
}
exports.MockComponent = MockComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25nLW1vY2tzL3NyYy9saWIvbW9jay1jb21wb25lbnQvbW9jay1jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxzQ0FXdUI7QUFDdkIsaURBQW1EO0FBRW5ELHdGQUFnRTtBQUNoRSxrRUFBMkM7QUFDM0MsdURBQXFEO0FBQ3JELDRHQUFtRjtBQUVuRixpRkFBdUU7QUFDdkUsb0ZBQTREO0FBQzVELHdFQUFnRDtBQUNoRCxxRUFBNEQ7QUFFNUQscUZBQW1GO0FBQ25GLGtGQUEwRDtBQUMxRCxzRkFBK0Q7QUFFL0QsaUZBQTBEO0FBQzFELDZEQUFzQztBQUd0QyxJQUFNLG1CQUFtQixHQUFHLFVBQzFCLFFBQTZDLEVBQzdDLElBQVksRUFDWixRQUFnQixFQUNoQixHQUFzQjtJQUV0QixJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFpQixJQUFJLFNBQUksUUFBVSxDQUFDLEVBQUU7UUFDbEQsUUFBUSxDQUFDLG1CQUFpQixJQUFJLFNBQUksUUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ3JELEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztLQUNyQjtJQUVELE9BQU8sUUFBUSxDQUFDLGdCQUFjLElBQUksU0FBSSxRQUFVLENBQUMsQ0FBQztBQUNwRCxDQUFDLENBQUM7QUFFRixJQUFNLHFCQUFxQixHQUFHLFVBQzVCLGFBQStCLEVBQy9CLEtBQWtDLEVBQ2xDLEtBQWE7OztRQUViLEtBQW1CLElBQUEsS0FBQSxTQUFBLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFBLGdCQUFBLDRCQUFFO1lBQXZDLElBQU0sSUFBSSxXQUFBO1lBQ2IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFD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LE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsaUVBQWlFO0lBQ2pFLElBQUssSUFBQSxvQkFBVSxHQUFVLENBQUMsYUFBYSxFQUFFO1FBQ3ZDLElBQUk7WUFDRixPQUFPLElBQUEsNENBQWdCLEVBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3pDO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCw4QkFBOEI7U0FDL0I7S0FDRjtJQUNELElBQUksMkJBQWUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLElBQUksMkJBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDbkcsT0FBTywyQkFBZSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUN6RDtJQUVELElBQU0sSUFBSSxHQUFHLElBQUEsMEJBQVcsRUFBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzVDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFL0IsdUJBQXVCO0lBQ3ZCLElBQUksMkJBQWUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUU7UUFDL0MsMkJBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3hEO0lBRUQsT0FBTyxJQUFXLENBQUM7QUFDckIsQ0FBQztBQTVCRCxzQ0E0QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIEluamVjdG9yLFxuICBPcHRpb25hbCxcbiAgUXVlcnlMaXN0LFxuICBTZWxmLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXRUZXN0QmVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcblxuaW1wb3J0IGNvcmVEZWZpbmVQcm9wZXJ0eSBmcm9tICcuLi9jb21tb24vY29yZS5kZWZpbmUtcHJvcGVydHknO1xuaW1wb3J0IGNvcmVGb3JtIGZyb20gJy4uL2NvbW1vbi9jb3JlLmZvcm0nO1xuaW1wb3J0IHsgZXh0ZW5kQ2xhc3MgfSBmcm9tICcuLi9jb21tb24vY29yZS5oZWxwZXJzJztcbmltcG9ydCBjb3JlUmVmbGVjdERpcmVjdGl2ZVJlc29sdmUgZnJvbSAnLi4vY29tbW9uL2NvcmUucmVmbGVjdC5kaXJlY3RpdmUtcmVzb2x2ZSc7XG5pbXBvcnQgeyBUeXBlIH0gZnJvbSAnLi4vY29tbW9uL2NvcmUudHlwZXMnO1xuaW1wb3J0IHsgZ2V0TW9ja2VkTmdEZWZPZiB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmdldC1tb2NrZWQtbmctZGVmLW9mJztcbmltcG9ydCBmdW5jSW1wb3J0RXhpc3RzIGZyb20gJy4uL2NvbW1vbi9mdW5jLmltcG9ydC1leGlzdHMnO1xuaW1wb3J0IGZ1bmNJc01vY2sgZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbW9jayc7XG5pbXBvcnQgeyBpc01vY2tOZ0RlZiB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmlzLW1vY2stbmctZGVmJztcbmltcG9ydCB7IE1vY2tDb25maWcgfSBmcm9tICcuLi9jb21tb24vbW9jayc7XG5pbXBvcnQgeyBMZWdhY3lDb250cm9sVmFsdWVBY2Nlc3NvciB9IGZyb20gJy4uL2NvbW1vbi9tb2NrLWNvbnRyb2wtdmFsdWUtYWNjZXNzb3InO1xuaW1wb3J0IG5nTW9ja3NVbml2ZXJzZSBmcm9tICcuLi9jb21tb24vbmctbW9ja3MtdW5pdmVyc2UnO1xuaW1wb3J0IGRlY29yYXRlRGVjbGFyYXRpb24gZnJvbSAnLi4vbW9jay9kZWNvcmF0ZS1kZWNsYXJhdGlvbic7XG5cbmltcG9ydCBnZW5lcmF0ZVRlbXBsYXRlIGZyb20gJy4vcmVuZGVyL2dlbmVyYXRlLXRlbXBsYXRlJztcbmltcG9ydCBnZXRLZXkgZnJvbSAnLi9yZW5kZXIvZ2V0LWtleSc7XG5pbXBvcnQgeyBNb2NrZWRDb21wb25lbnQgfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgbWl4UmVuZGVyUHJlcGFyZVZjciA9IChcbiAgaW5zdGFuY2U6IE1vY2tDb25maWcgJiBSZWNvcmQ8a2V5b2YgYW55LCBhbnk+LFxuICB0eXBlOiBzdHJpbmcsXG4gIHNlbGVjdG9yOiBzdHJpbmcsXG4gIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4pOiBWaWV3Q29udGFpbmVyUmVmIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFpbnN0YW5jZVtgbmdNb2Nrc1JlbmRlcl8ke3R5cGV9XyR7c2VsZWN0b3J9YF0pIHtcbiAgICBpbnN0YW5jZVtgbmdNb2Nrc1JlbmRlcl8ke3R5cGV9XyR7c2VsZWN0b3J9YF0gPSB0cnVlO1xuICAgIGNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICByZXR1cm4gaW5zdGFuY2VbYF9fbW9ja1ZpZXdfJHt0eXBlfV8ke3NlbGVjdG9yfWBdO1xufTtcblxuY29uc3QgbWl4UmVuZGVyUmVvcmRlclZpZXdzID0gKFxuICB2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxuICB2aWV3czogQXJyYXk8RW1iZWRkZWRWaWV3UmVmPGFueT4+LFxuICBpbmRleDogbnVtYmVyLFxuKTogdm9pZCA9PiB7XG4gIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cy5zcGxpY2UoaW5kZXggKyAxKSkge1xuICAgIHZpZXcuZGVzdHJveSgpO1xuICB9XG5cbiAgbGV0IHZpZXdJbmRleCA9IDA7XG4gIGZvciAoY29uc3QgdmlldyBvZiB2aWV3cykge1xuICAgIGlmICghdmlldykge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIHZpZXdDb250YWluZXIubW92ZSh2aWV3LCB2aWV3SW5kZXgpO1xuICAgIHZpZXdJbmRleCArPSAxO1xuICB9XG59O1xuXG5jb25zdCBtaXhSZW5kZXJBcHBseUNvbnRleHQgPSAodmlldzogRW1iZWRkZWRWaWV3UmVmPGFueT4sIGNvbnRleHQ6IFJlY29yZDxhbnksIGFueT4pOiB2b2lkID0+IHtcbiAgZm9yIChjb25zdCBjb250ZXh0S2V5IG9mIE9iamVjdC5rZXlzKHZpZXcuY29udGV4dCkpIHtcbiAgICB2aWV3LmNvbnRleHRbY29udGV4dEtleV0gPSB1bmRlZmluZWQ7XG4gIH1cbiAgZm9yIChjb25zdCBjb250ZXh0S2V5IG9mIE9iamVjdC5rZXlzKGNvbnRleHQpKSB7XG4gICAgdmlldy5jb250ZXh0W2NvbnRleHRLZXldID0gKGNvbnRleHQgYXMgYW55KVtjb250ZXh0S2V5XTtcbiAgfVxuICB2aWV3Lm1hcmtGb3JDaGVjaygpO1xufTtcblxuY29uc3QgbWl4UmVuZGVySGFuZGxlVmlld3MgPSAoXG4gIHZjcjogVmlld0NvbnRhaW5lclJlZixcbiAgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgdGVtcGxhdGVzOiBhbnlbXSxcbiAgdmlld3M6IEFycmF5PEVtYmVkZGVkVmlld1JlZjxhbnk+PixcbiAgaW5kaWNlczogdW5kZWZpbmVkIHwgbnVtYmVyW10sXG4gIGNvbnRleHQ6IFJlY29yZDxhbnksIGFueT4sXG4pOiBudW1iZXIgPT4ge1xuICBsZXQgaW5kZXggPSAtMTtcblxuICBmb3IgKGNvbnN0IHRlbXBsYXRlUmVmIG9mIHRlbXBsYXRlcykge1xuICAgIGluZGV4ICs9IDE7XG4gICAgdmlld3NbaW5kZXhdID0gdmlld3NbaW5kZXhdIHx8IHVuZGVmaW5lZDtcbiAgICBpZiAoKGluZGljZXMgJiYgaW5kaWNlcy5pbmRleE9mKGluZGV4KSA9PT0gLTEpIHx8ICF0ZW1wbGF0ZVJlZikge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmICghKHRlbXBsYXRlUmVmIGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIFRlbXBsYXRlUmVmYCk7XG4gICAgfVxuICAgIGlmICghdmlld3NbaW5kZXhdKSB7XG4gICAgICB2aWV3c1tpbmRleF0gPSB2Y3IuY3JlYXRlRW1iZWRkZWRWaWV3KHRlbXBsYXRlUmVmLCB7fSk7XG4gICAgfVxuICAgIG1peFJlbmRlckFwcGx5Q29udGV4dCh2aWV3c1tpbmRleF0sIGNvbnRleHQpO1xuICB9XG4gIGNkci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgcmV0dXJuIGluZGV4O1xufTtcblxuY29uc3QgbWl4UmVuZGVyID0gKGluc3RhbmNlOiBNb2NrQ29uZmlnICYgUmVjb3JkPGtleW9mIGFueSwgYW55PiwgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZik6IHZvaWQgPT4ge1xuICAvLyBQcm92aWRpbmcgYSBtZXRob2QgdG8gcmVuZGVyIGFueSBAQ29udGVudENoaWxkIGJhc2VkIG9uIGl0cyBzZWxlY3Rvci5cbiAgY29yZURlZmluZVByb3BlcnR5KFxuICAgIGluc3RhbmNlLFxuICAgICdfX3JlbmRlcicsXG4gICAgKGNvbnRlbnRDaGlsZFNlbGVjdG9yOiBzdHJpbmcgfCBbc3RyaW5nLCAuLi5udW1iZXJbXV0sICRpbXBsaWNpdD86IGFueSwgdmFyaWFibGVzPzogUmVjb3JkPGtleW9mIGFueSwgYW55PikgPT4ge1xuICAgICAgY29uc3QgW3R5cGUsIGtleSwgc2VsZWN0b3IsIGluZGljZXNdID0gZ2V0S2V5KGNvbnRlbnRDaGlsZFNlbGVjdG9yKTtcblxuICAgICAgY29uc3QgdmNyID0gbWl4UmVuZGVyUHJlcGFyZVZjcihpbnN0YW5jZSwgdHlwZSwgc2VsZWN0b3IsIGNkcik7XG4gICAgICBpZiAoIXZjcikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb3BlcnR5OiBhbnkgPSBpbnN0YW5jZVtrZXldO1xuICAgICAgY29uc3QgdGVtcGxhdGVzID0gcHJvcGVydHkgaW5zdGFuY2VvZiBRdWVyeUxpc3QgPyBwcm9wZXJ0eS50b0FycmF5KCkgOiBbcHJvcGVydHldO1xuXG4gICAgICBjb25zdCB2aWV3cyA9IGluc3RhbmNlW2BuZ01vY2tzUmVuZGVyXyR7dHlwZX1fJHtzZWxlY3Rvcn1fdmlld3NgXSB8fCBbXTtcbiAgICAgIGNvbnN0IGluZGV4ID0gbWl4UmVuZGVySGFuZGxlVmlld3ModmNyLCBjZHIsIHRlbXBsYXRlcywgdmlld3MsIGluZGljZXMsIHsgLi4udmFyaWFibGVzLCAkaW1wbGljaXQgfSk7XG5cbiAgICAgIG1peFJlbmRlclJlb3JkZXJWaWV3cyh2Y3IsIHZpZXdzLCBpbmRleCk7XG4gICAgICBpbnN0YW5jZVtgbmdNb2Nrc1JlbmRlcl8ke3R5cGV9XyR7c2VsZWN0b3J9X3ZpZXdzYF0gPSB2aWV3cztcbiAgICAgIGNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfSxcbiAgKTtcbn07XG5cbmNvbnN0IG1peEhpZGVIYW5kbGVyID0gKFxuICBpbnN0YW5jZTogTW9ja0NvbmZpZyAmIFJlY29yZDxrZXlvZiBhbnksIGFueT4sXG4gIHR5cGU6IHN0cmluZyxcbiAgc2VsZWN0b3I6IHN0cmluZyxcbiAgaW5kaWNlczogdW5kZWZpbmVkIHwgbnVtYmVyW10sXG4pID0+IHtcbiAgY29uc3Qgdmlld3MgPSBpbnN0YW5jZVtgbmdNb2Nrc1JlbmRlcl8ke3R5cGV9XyR7c2VsZWN0b3J9X3ZpZXdzYF07XG4gIGxldCBpbmRleCA9IC0xO1xuICBmb3IgKGNvbnN0IHZpZXcgb2Ygdmlld3MpIHtcbiAgICBpbmRleCArPSAxO1xuICAgIGlmICgoaW5kaWNlcyAmJiBpbmRpY2VzLmluZGV4T2YoaW5kZXgpID09PSAtMSkgfHwgIXZpZXcpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICB2aWV3LmRlc3Ryb3koKTtcbiAgICB2aWV3c1tpbmRleF0gPSB1bmRlZmluZWQ7XG4gIH1cbn07XG5cbmNvbnN0IG1peEhpZGUgPSAoaW5zdGFuY2U6IE1vY2tDb25maWcgJiBSZWNvcmQ8a2V5b2YgYW55LCBhbnk+LCBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYpOiB2b2lkID0+IHtcbiAgLy8gUHJvdmlkaW5nIG1ldGhvZCB0byBoaWRlIGFueSBAQ29udGVudENoaWxkIGJhc2VkIG9uIGl0cyBzZWxlY3Rvci5cbiAgY29yZURlZmluZVByb3BlcnR5KGluc3RhbmNlLCAnX19oaWRlJywgKGNvbnRlbnRDaGlsZFNlbGVjdG9yOiBzdHJpbmcgfCBbc3RyaW5nLCAuLi5udW1iZXJbXV0pID0+IHtcbiAgICBjb25zdCBbdHlwZSwgLCBzZWxlY3RvciwgaW5kaWNlc10gPSBnZXRLZXkoY29udGVudENoaWxkU2VsZWN0b3IpO1xuXG4gICAgaWYgKCFpbnN0YW5jZVtgbmdNb2Nrc1JlbmRlcl8ke3R5cGV9XyR7c2VsZWN0b3J9YF0pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbWl4SGlkZUhhbmRsZXIoaW5zdGFuY2UsIHR5cGUsIHNlbGVjdG9yLCBpbmRpY2VzKTtcblxuICAgIGlmICghaW5kaWNlcykge1xuICAgICAgaW5zdGFuY2VbYG5nTW9ja3NSZW5kZXJfJHt0eXBlfV8ke3NlbGVjdG9yfWBdID0gZmFsc2U7XG4gICAgfVxuICAgIGNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgfSk7XG59O1xuXG5jbGFzcyBDb21wb25lbnRNb2NrQmFzZSBleHRlbmRzIExlZ2FjeUNvbnRyb2xWYWx1ZUFjY2Vzc29yIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gIC8vIGlzdGFuYnVsIGlnbm9yZSBuZXh0XG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgbmdDb250cm9sOiBhbnksIC8vIE5nQ29udHJvbFxuICAgIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgKSB7XG4gICAgc3VwZXIoaW5qZWN0b3IsIG5nQ29udHJvbCk7XG4gICAgaWYgKGZ1bmNJc01vY2sodGhpcykpIHtcbiAgICAgIG1peFJlbmRlcih0aGlzLCBjaGFuZ2VEZXRlY3Rvcik7XG4gICAgICBtaXhIaWRlKHRoaXMsIGNoYW5nZURldGVjdG9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbmdBZnRlckNvbnRlbnRJbml0KCk6IHZvaWQge1xuICAgIGNvbnN0IGNvbmZpZyA9ICh0aGlzLl9fbmdNb2Nrc0NvbmZpZyBhcyBhbnkpLmNvbmZpZztcbiAgICBpZiAoISh0aGlzIGFzIGFueSkuX19yZW5kZXJlZCAmJiBjb25maWcgJiYgY29uZmlnLnJlbmRlcikge1xuICAgICAgZm9yIChjb25zdCBibG9jayBvZiBPYmplY3Qua2V5cyhjb25maWcucmVuZGVyKSkge1xuICAgICAgICBjb25zdCB7ICRpbXBsaWNpdCwgdmFyaWFibGVzIH0gPVxuICAgICAgICAgIGNvbmZpZy5yZW5kZXJbYmxvY2tdICE9PSB0cnVlXG4gICAgICAgICAgICA/IGNvbmZpZy5yZW5kZXJbYmxvY2tdXG4gICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICAkaW1wbGljaXQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICB2YXJpYWJsZXM6IHt9LFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAodGhpcyBhcyBhbnkpLl9fcmVuZGVyKGJsb2NrLCAkaW1wbGljaXQsIHZhcmlhYmxlcyk7XG4gICAgICB9XG4gICAgICAodGhpcyBhcyBhbnkpLl9fcmVuZGVyZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxufVxuXG5jb3JlRGVmaW5lUHJvcGVydHkoQ29tcG9uZW50TW9ja0Jhc2UsICdwYXJhbWV0ZXJzJywgW1xuICBbSW5qZWN0b3JdLFxuICBbY29yZUZvcm0uTmdDb250cm9sIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovICgoKSA9PiB1bmRlZmluZWQpLCBuZXcgT3B0aW9uYWwoKSwgbmV3IFNlbGYoKV0sXG4gIFtDaGFuZ2VEZXRlY3RvclJlZl0sXG5dKTtcblxuY29uc3QgZGVjb3JhdGVDbGFzcyA9IChjb21wb25lbnQ6IFR5cGU8YW55PiwgbW9jazogVHlwZTxhbnk+KTogdm9pZCA9PiB7XG4gIGNvbnN0IG1ldGEgPSBjb3JlUmVmbGVjdERpcmVjdGl2ZVJlc29sdmUoY29tcG9uZW50KTtcbiAgY29uc3QgeyBleHBvcnRBcywgaW5wdXRzLCBvdXRwdXRzLCBxdWVyaWVzLCBzZWxlY3RvciwgcHJvdmlkZXJzLCB2aWV3UHJvdmlkZXJzIH0gPSBtZXRhO1xuICBjb25zdCB0ZW1wbGF0ZSA9IGdlbmVyYXRlVGVtcGxhdGUocXVlcmllcyk7XG4gIGNvbnN0IG1vY2tNZXRhID0geyBpbnB1dHMsIG91dHB1dHMsIHByb3ZpZGVycywgdmlld1Byb3ZpZGVycywgcXVlcmllcyB9O1xuICBjb25zdCBtb2NrUGFyYW1zID0geyBleHBvcnRBcywgc2VsZWN0b3IsIHRlbXBsYXRlIH07XG4gIENvbXBvbmVudChkZWNvcmF0ZURlY2xhcmF0aW9uKGNvbXBvbmVudCwgbW9jaywgbW9ja01ldGEsIG1vY2tQYXJhbXMpKShtb2NrKTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBNb2NrQ29tcG9uZW50cyguLi5jb21wb25lbnRzOiBBcnJheTxUeXBlPGFueT4+KTogQXJyYXk8VHlwZTxNb2NrZWRDb21wb25lbnQ8YW55Pj4+IHtcbiAgcmV0dXJuIGNvbXBvbmVudHMubWFwKE1vY2tDb21wb25lbnQpO1xufVxuXG4vKipcbiAqIEBzZWUgaHR0cHM6Ly9uZy1tb2Nrcy5zdWRvLmV1L2FwaS9Nb2NrQ29tcG9uZW50XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBNb2NrQ29tcG9uZW50PFRDb21wb25lbnQ+KGNvbXBvbmVudDogVHlwZTxUQ29tcG9uZW50Pik6IFR5cGU8TW9ja2VkQ29tcG9uZW50PFRDb21wb25lbnQ+PiB7XG4gIGZ1bmNJbXBvcnRFeGlzdHMoY29tcG9uZW50LCAnTW9ja0NvbXBvbmVudCcpO1xuXG4gIGlmIChpc01vY2tOZ0RlZihjb21wb25lbnQsICdjJykpIHtcbiAgICByZXR1cm4gY29tcG9uZW50O1xuICB9XG5cbiAgLy8gV2UgYXJlIGluc2lkZSBvZiBhbiAnaXQnLiBJdCBpcyBmaW5lIHRvIHRvIHJldHVybiBhIG1vY2sgY29weS5cbiAgaWYgKChnZXRUZXN0QmVkKCkgYXMgYW55KS5faW5zdGFudGlhdGVkKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBnZXRNb2NrZWROZ0RlZk9mKGNvbXBvbmVudCwgJ2MnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gbG9va3MgbGlrZSBhbiBpbi10ZXN0IG1vY2suXG4gICAgfVxuICB9XG4gIGlmIChuZ01vY2tzVW5pdmVyc2UuZmxhZ3MuaGFzKCdjYWNoZUNvbXBvbmVudCcpICYmIG5nTW9ja3NVbml2ZXJzZS5jYWNoZURlY2xhcmF0aW9ucy5oYXMoY29tcG9uZW50KSkge1xuICAgIHJldHVybiBuZ01vY2tzVW5pdmVyc2UuY2FjaGVEZWNsYXJhdGlvbnMuZ2V0KGNvbXBvbmVudCk7XG4gIH1cblxuICBjb25zdCBtb2NrID0gZXh0ZW5kQ2xhc3MoQ29tcG9uZW50TW9ja0Jhc2UpO1xuICBkZWNvcmF0ZUNsYXNzKGNvbXBvbmVudCwgbW9jayk7XG5cbiAgLy8gaXN0YW5idWwgaWdub3JlIGVsc2VcbiAgaWYgKG5nTW9ja3NVbml2ZXJzZS5mbGFncy5oYXMoJ2NhY2hlQ29tcG9uZW50JykpIHtcbiAgICBuZ01vY2tzVW5pdmVyc2UuY2FjaGVEZWNsYXJhdGlvbnMuc2V0KGNvbXBvbmVudCwgbW9jayk7XG4gIH1cblxuICByZXR1cm4gbW9jayBhcyBhbnk7XG59XG4iXX0=